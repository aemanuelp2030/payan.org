<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emanuel Payan | Burn</title>

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --muted: rgba(255,255,255,.75);
      --border:#fff;
      --blue:#007BFF;
      --bad:#f33;

      --font: Chicago, Geneva, Monaco, "Courier New", monospace;
      --fs: 15px;

      --pad: 14px;
      --pad2: 20px;
      --gap: 14px;
      --radius: 0px; /* keep “terminal” look */
    }

    html, body{
      margin:0;
      height:100%;
      background:var(--bg);
      color:var(--fg);
      font-family:var(--font);
      font-size:var(--fs);
    }

    a{ color:var(--fg); text-decoration:none; }
  

    .wrap{
      padding:18px;
      max-width:1200px;
      margin:0 auto;
    }

    /* Header */
    .header{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:16px;
    }

    .title{
      letter-spacing:.5px;
      font-weight:normal;
      margin:0;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      line-height:1.6;
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      line-height:1.6;
    }

    .muted{ color:var(--muted); }
    .blue{ color:var(--blue); }
    .bad{ color:var(--bad); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
    }

    .card{
      border:1px solid var(--border);
      padding: var(--pad);
      border-radius: var(--radius);
      min-width:0;
    }

    .card h2{
      font-size:var(--fs);
      font-weight:normal;
      margin:0 0 10px 0;
    }

    .span-12{ grid-column: span 12; }
    .span-8{ grid-column: span 8; }
    .span-6{ grid-column: span 6; }
    .span-4{ grid-column: span 4; }

    @media (max-width: 1000px){
      .span-8, .span-6, .span-4 { grid-column: span 12; }
    }

    /* Forms / rows */
    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .kv{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:10px;
      align-items:center;
    }

    @media (max-width: 560px){
      .kv{ grid-template-columns: 1fr; }
    }

    .input, select, textarea{
      background:var(--bg);
      color:var(--fg);
      border:1px solid var(--border);
      padding:6px 8px;
      font-family:inherit;
      font-size:var(--fs);
      box-sizing:border-box;
      width:100%;
      border-radius: var(--radius);
    }

    .input.tiny{ max-width:90px; }
    .input.small{ max-width:140px; }
    .input.mid{ max-width:220px; }

    .btn{
      background:var(--bg);
      color:var(--fg);
      border:1px solid var(--border);
      padding:6px 10px;
      font-family:inherit;
      font-size:var(--fs);
      cursor:pointer;
      border-radius: var(--radius);
    }
    .btn:hover{ background: rgba(255,255,255,.06); }

    /* Tables */
    table{
      border-collapse:collapse;
      width:100%;
    }
    th, td{
      border:1px solid var(--border);
      padding:6px 8px;
      vertical-align:top;
      font-weight:normal;
    }
    th{ text-align:left; }
    td.num{ text-align:right; white-space:nowrap; }
    td.center{ text-align:center; }

    .table-wrap{
      overflow:auto;
      border:1px solid var(--border);
    }
    .table-wrap table{
      border:none;
      min-width:900px;
    }
    .table-wrap th, .table-wrap td{
      border:1px solid var(--border);
    }

    /* Pre / charts */
    pre{
      margin:0;
      border:1px solid var(--border);
      padding:10px;
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.6;
    }

    .chart{
      border:1px solid var(--border);
      padding:10px;
      overflow:auto;
    }
    .chart-title{
      margin-bottom:8px;
    }

    /* Section action row */
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
      /* Header name link: never underline */
.title a,
.title a:hover,
.title a:focus,
.title a:active{
  text-decoration:none;
}

    }
    /* Make header flush-left to viewport */
.wrap{
  max-width:none;
  margin:0;
  padding-left:5;
  padding-right:0;
}

.header{
  padding-left:18px;  /* keep same look as rest of page */
  padding-right:18px;
  align-items:flex-start;
  text-align:left;
}

.topbar, .meta{
  justify-content:flex-start;
}

  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
  <h1 class="title">
    <a href="https://payan.org/">Emanuel Payan</a> | Burn
  </h1>

  <div class="topbar">
    SYNC: <span class="blue" id="sync">LOCKED</span>
    <span class="muted">|</span>
    <button class="btn" id="logoutBtn">LOGOUT</button>
    <span class="muted" id="err" style="display:none;">| <span class="bad">ERROR</span> (console)</span>
  </div>
</div>

      <div class="meta">
        <span class="muted">LAST UPDATED:</span>
        <span class="blue" id="lastUpdated">—</span>
      </div>
    </div>

    <!-- Top: Inputs + Summary -->
    <div class="grid">
      <div class="card span-6">
        <h2>Inputs</h2>
        <div class="form">
          <div class="kv">
            <div>Avg Net Monthly Income</div>
            <input class="input mid" id="avgIncome" value="3464.00" disabled>
          </div>
          <div class="kv">
            <div>One-Time Inflow</div>
            <input class="input mid" id="inflow" value="3000.00" disabled>
          </div>
          <div class="kv">
            <div>Cash on Hand (ref)</div>
            <input class="input mid" id="cash" value="2578.89" disabled>
          </div>
        </div>
      </div>

      <div class="card span-6">
        <h2>Monthly Summary</h2>
        <div class="form">
          <div class="kv"><div>Total Monthly Burn</div><div class="blue" id="burnTotal">—</div></div>
          <div class="kv"><div>Left / mo</div><div class="blue" id="leftMo">—</div></div>
          <div class="kv"><div>Income:Expense Ratio</div><div class="blue" id="ratio">—</div></div>
          <div class="kv"><div>Daily Burn</div><div class="blue" id="daily">—</div></div>
          <div class="kv"><div>Weekly Burn</div><div class="blue" id="weekly">—</div></div>
          <div class="kv"><div>Burn / Year</div><div class="blue" id="yearly">—</div></div>
          <div class="kv"><div>Runway (after inflow)</div><div class="blue" id="runway1">—</div></div>
          <div class="kv"><div>Burn countdown</div><div class="blue" id="burnCountdown">—</div></div>
        </div>
      </div>

      <!-- Net worth -->
      <div class="card span-6">
        <h2>Net Worth Inputs</h2>
        <div class="form">
          <div class="kv">
            <div>Assets (Liquid)</div>
            <input class="input mid" id="assetLiquid" value="5578.89" disabled>
          </div>
          <div class="kv">
            <div>Assets (Other)</div>
            <input class="input mid" id="assetOther" value="0.00" disabled>
          </div>
          <div class="kv">
            <div>Liabilities (Debt)</div>
            <input class="input mid" id="liabDebt" value="0.00" disabled>
          </div>
        </div>
      </div>

      <div class="card span-6">
        <h2>Net Worth Projections</h2>
        <div class="form">
          <div class="kv"><div>Net Worth</div><div class="blue" id="netWorth">—</div></div>
          <div class="kv"><div>30d Projection</div><div class="blue" id="nw30">—</div></div>
          <div class="kv"><div>90d Projection</div><div class="blue" id="nw90">—</div></div>
          <div class="kv"><div>365d Projection</div><div class="blue" id="nw365">—</div></div>
        </div>
      </div>

      <!-- Due -->
      <div class="card span-12">
        <h2>Upcoming Due (14d)</h2>
        <pre class="mono" id="dueList">—</pre>
      </div>

      <!-- Line items -->
      <div class="card span-12">
        <h2>Line Items</h2>
        <div class="actions">
          <button class="btn" id="addRow" disabled>ADD LINE</button>
          <button class="btn" id="saveNow" disabled>SAVE NOW</button>
          <span class="muted">Autosaves after edits.</span>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:14%;">CATEGORY</th>
                <th style="width:28%;">ITEM</th>
                <th style="width:12%;">AMOUNT</th>
                <th style="width:12%;">DUE</th>
                <th style="width:30%;">NOTES</th>
                <th style="width:4%;">X</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>

      <!-- Snapshots -->
      <div class="card span-12">
        <h2>Snapshots</h2>
        <div class="actions">
          <button class="btn" id="snapDaily" disabled>DAILY</button>
          <button class="btn" id="snapWeekly" disabled>WEEKLY</button>
          <span class="muted">Saved to Google Sheets.</span>
        </div>

        <div class="grid">
          <div class="span-6">
            <div class="muted" style="margin-bottom:6px;">DAILY (last 30)</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>DATE</th>
                    <th class="num">BURN</th>
                    <th class="num">INCOME</th>
                    <th class="num">CASH</th>
                    <th class="num">NET</th>
                    <th class="num">RUNWAY</th>
                  </tr>
                </thead>
                <tbody id="dailyRows"></tbody>
              </table>
            </div>
          </div>

          <div class="span-6">
            <div class="muted" style="margin-bottom:6px;">WEEKLY (last 26)</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>WEEK</th>
                    <th class="num">BURN</th>
                    <th class="num">INCOME</th>
                    <th class="num">CASH</th>
                    <th class="num">NET</th>
                    <th class="num">RUNWAY</th>
                  </tr>
                </thead>
                <tbody id="weeklyRows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="card span-12">
        <h2>Charts</h2>

        <div class="chart">
          <div class="chart-title">NET WORTH (daily snapshots)</div>
          <div id="chartNetWorth">—</div>
        </div>

        <div class="chart" style="margin-top:12px;">
          <div class="chart-title">CASH (daily snapshots)</div>
          <div id="chartCash">—</div>
        </div>
      </div>

      <!-- Notes -->
      <div class="card span-12">
        <h2>Notes</h2>
        <div class="actions">
          <button class="btn" id="saveNote" disabled>SAVE NOTE</button>
          <span class="muted">Saved to Google Sheets.</span>
        </div>
        <textarea rows="6" id="notes" placeholder="Write note, then click SAVE NOTE…" disabled></textarea>
      </div>

      <div class="card span-12">
        <h2>Note History</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:22%;">TIME</th>
                <th>NOTE</th>
              </tr>
            </thead>
            <tbody id="noteRows"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Your original script (unchanged) -->
  <script>
    (() => {
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHUYAzQBNE5qQXOs07z7Gg_d78qZOb4WNCirHBeJOSSRcOMMx-NxWqHTTzTZOvFmjo3w/exec";
      const TOKEN_KEY = "emanuel_burn_token_session";
      const $ = (id) => document.getElementById(id);

      function token(){ return sessionStorage.getItem(TOKEN_KEY) || ""; }
      if (!token()){
        window.location.replace("/burn.html");
        return;
      }

      const num = (x) => (isFinite(+x) ? +x : 0);
      const money = (n) => (isFinite(n) ? "$" + Number(n).toFixed(2) : "—");
      const pad2 = (x) => String(x).padStart(2,"0");
      const ymd = (d) => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
      const fmt = (d) =>
        d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+
        " "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());

      function weekStartISO(d){
        const x = new Date(d);
        const day = (x.getDay()+6)%7; // Mon=0
        x.setHours(0,0,0,0);
        x.setDate(x.getDate() - day);
        return ymd(x);
      }

      function setSync(text){ $("sync").textContent = text; }
      function showErr(on){ $("err").style.display = on ? "" : "none"; }

      async function apiGet(action){
        try{
          const url = `${SCRIPT_URL}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(token())}`;
          const res = await fetch(url, { cache:"no-cache" });
          const text = await res.text();
          try { return JSON.parse(text); }
          catch { return { error:"bad_json", text }; }
        }catch(e){
          return { error:"fetch_failed", text:String(e) };
        }
      }

      async function apiPost(action, payload){
        try{
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action, token: token(), ...payload })
          });
          const text = await res.text();
          try { return JSON.parse(text); }
          catch { return { error:"bad_json", text }; }
        }catch(e){
          return { error:"fetch_failed", text:String(e) };
        }
      }

      function enableUI(on){
        ["avgIncome","inflow","cash","assetLiquid","assetOther","liabDebt",
         "snapDaily","snapWeekly","saveNote","notes","addRow","saveNow"].forEach(id=>{
          if ($(id)) $(id).disabled = !on;
        });
        document.querySelectorAll("#rows input, #rows button").forEach(el=>{
          el.disabled = !on;
        });
      }

      const DEFAULT = {
        avgIncome: 3464.00,
        inflow: 3000.00,
        cash: 2578.89,

        assetLiquid: 5578.89,
        assetOther: 0.00,
        liabDebt: 0.00,

        rows: [
          {cat:"LIVING", item:"Housing - Rent", amount:800.00, due:"01", notes:"Due 1st"},
          {cat:"LIVING", item:"Internet", amount:20.00, due:"", notes:"Monthly"},
          {cat:"LIVING", item:"Food", amount:650.00, due:"", notes:"Monthly"},
          {cat:"TRANSPORTATION", item:"Gas", amount:250.00, due:"", notes:"Monthly"},
          {cat:"TRANSPORTATION", item:"Car Payment #1", amount:369.89, due:"11", notes:"Due 11th"},
          {cat:"TRANSPORTATION", item:"Car Payment #2", amount:285.98, due:"17", notes:"Due 17th"}
        ],
        updatedAt: ""
      };

      function parseState(sheetState){
        const out = {};
        out.avgIncome = num(sheetState.avgIncome ?? DEFAULT.avgIncome);
        out.inflow = num(sheetState.inflow ?? DEFAULT.inflow);
        out.cash = num(sheetState.cash ?? DEFAULT.cash);

        out.assetLiquid = num(sheetState.assetLiquid ?? DEFAULT.assetLiquid);
        out.assetOther  = num(sheetState.assetOther ?? DEFAULT.assetOther);
        out.liabDebt    = num(sheetState.liabDebt ?? DEFAULT.liabDebt);

        try { out.rows = JSON.parse(sheetState.rowsJson || "null") || DEFAULT.rows; }
        catch { out.rows = DEFAULT.rows; }

        out.rows = (out.rows || []).map(r => ({
          cat: r.cat || "",
          item: r.item || "",
          amount: num(r.amount),
          due: r.due || "",
          notes: r.notes || ""
        }));

        out.updatedAt = String(sheetState.updatedAt || "");
        return out;
      }

      function buildSheetState(state){
        return {
          avgIncome: String(state.avgIncome),
          inflow: String(state.inflow),
          cash: String(state.cash),

          assetLiquid: String(state.assetLiquid),
          assetOther: String(state.assetOther),
          liabDebt: String(state.liabDebt),

          rowsJson: JSON.stringify(state.rows),
          updatedAt: new Date().toISOString()
        };
      }

      function esc(s){
        return String(s)
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function renderTable(state){
        const tbody = $("rows");
        tbody.innerHTML = "";

        state.rows.forEach((r, idx)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input class="input cat" data-idx="${idx}" value="${esc(r.cat||"")}"></td>
            <td><input class="input item" data-idx="${idx}" value="${esc(r.item||"")}"></td>
            <td class="num"><input class="input amt" data-idx="${idx}" value="${num(r.amount).toFixed(2)}"></td>
            <td><input class="input due" data-idx="${idx}" placeholder="DD / MM-DD / EOM" value="${esc(r.due||"")}"></td>
            <td><input class="input note" data-idx="${idx}" value="${esc(r.notes||"")}"></td>
            <td class="center"><button class="btn del" data-idx="${idx}">X</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      function endOfMonthDate(d){
        const x = new Date(d.getFullYear(), d.getMonth()+1, 0);
        x.setHours(0,0,0,0);
        return x;
      }

      function parseDueToDate(dueStr, now){
        const s = String(dueStr || "").trim();
        if (!s) return null;

        if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
          const dt = new Date(s + "T00:00:00");
          return isNaN(dt.getTime()) ? null : dt;
        }
        if (s.toUpperCase() === "EOM") return endOfMonthDate(now);

        if (/^\d{2}-\d{2}$/.test(s)){
          const [mm, dd] = s.split("-").map(Number);
          if (!mm || !dd) return null;
          let dt = new Date(now.getFullYear(), mm-1, dd);
          dt.setHours(0,0,0,0);
          const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          if (dt < today0){
            dt = new Date(now.getFullYear()+1, mm-1, dd);
            dt.setHours(0,0,0,0);
          }
          return dt;
        }

        if (/^\d{1,2}$/.test(s)){
          const dd = Number(s);
          if (!dd) return null;
          let dt = new Date(now.getFullYear(), now.getMonth(), dd);
          dt.setHours(0,0,0,0);
          const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          if (dt < today0){
            dt = new Date(now.getFullYear(), now.getMonth()+1, dd);
            dt.setHours(0,0,0,0);
          }
          return dt;
        }

        return null;
      }

      function renderDueList(state){
        const el = $("dueList");
        const now = new Date();
        const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const horizon = new Date(today0);
        horizon.setDate(horizon.getDate() + 14);

        const upcoming = state.rows
          .map(r => ({ r, dueDate: parseDueToDate(r.due, now) }))
          .filter(x => x.dueDate && x.dueDate >= today0 && x.dueDate <= horizon)
          .sort((a,b)=>a.dueDate-b.dueDate);

        if (!upcoming.length){ el.textContent = "—"; return; }

        el.textContent = upcoming.map(x=>{
          const d = x.dueDate;
          const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
          return `${ds}  ${money(num(x.r.amount))}  ${x.r.item}`;
        }).join("\n");
      }

      function secondsToDHMS(sec){
        if (!isFinite(sec) || sec < 0) return "—";
        sec = Math.floor(sec);
        const d = Math.floor(sec / 86400); sec %= 86400;
        const h = Math.floor(sec / 3600);  sec %= 3600;
        const m = Math.floor(sec / 60);    sec %= 60;
        return `${d}d ${pad2(h)}:${pad2(m)}:${pad2(sec)}`;
      }

      function calc(state){
        const burnTotal = state.rows.reduce((sum, r)=> sum + num(r.amount), 0);
        const leftMo = state.avgIncome - burnTotal;

        const daily = burnTotal / 30.437;
        const weekly = daily * 7;
        const yearly = burnTotal * 12;

        const cashAfter = state.cash + state.inflow;
        const runway1 = daily > 0 ? (cashAfter / daily) : Infinity;

        const netWorth = (state.assetLiquid + state.assetOther) - state.liabDebt;

        const nw30  = netWorth + (leftMo/30.437)*30;
        const nw90  = netWorth + (leftMo/30.437)*90;
        const nw365 = netWorth + (leftMo/30.437)*365;

        const ratio = burnTotal > 0 ? (state.avgIncome / burnTotal) : Infinity;

        return { burnTotal, leftMo, daily, weekly, yearly, runway1, ratio, netWorth, nw30, nw90, nw365 };
      }

      function renderCalc(state){
        const c = calc(state);

        $("burnTotal").textContent = money(c.burnTotal);
        $("leftMo").textContent    = money(c.leftMo);
        $("daily").textContent     = money(c.daily);
        $("weekly").textContent    = money(c.weekly);
        $("yearly").textContent    = money(c.yearly);
        $("runway1").textContent   = isFinite(c.runway1) ? c.runway1.toFixed(0) : "∞";
        $("ratio").textContent     = isFinite(c.ratio) ? c.ratio.toFixed(2) : "∞";

        $("netWorth").textContent  = money(c.netWorth);
        $("nw30").textContent      = money(c.nw30);
        $("nw90").textContent      = money(c.nw90);
        $("nw365").textContent     = money(c.nw365);

        window.__burnCountdownSeconds = isFinite(c.runway1) ? Math.floor(c.runway1 * 86400) : Infinity;
        $("burnCountdown").textContent = secondsToDHMS(window.__burnCountdownSeconds);

        renderDueList(state);
        return c;
      }

      function sparkSVG(series, width=900, height=160){
        const vals = series.filter(v => v!=null && isFinite(v));
        if (!vals.length) return `<span class="muted">—</span>`;

        const min = Math.min(...vals);
        const max = Math.max(...vals);
        const pad = 10;

        const scaleX = (i) => pad + (i * (width - pad*2) / Math.max(1, series.length-1));
        const scaleY = (v) => {
          if (max === min) return height/2;
          const t = (v - min) / (max - min);
          return (height - pad) - t * (height - pad*2);
        };

        let pts = "";
        series.forEach((v,i)=>{
          if (v==null || !isFinite(v)) return;
          pts += `${scaleX(i)},${scaleY(v)} `;
        });

        return `
<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="${width}" height="${height}" fill="#000"/>
  <rect x="0.5" y="0.5" width="${width-1}" height="${height-1}" fill="none" stroke="#fff"/>
  <polyline fill="none" stroke="#007BFF" stroke-width="2" points="${pts.trim()}"/>
  <text x="10" y="18" fill="#fff" font-size="12">${esc(money(max))}</text>
  <text x="10" y="${height-10}" fill="#fff" font-size="12">${esc(money(min))}</text>
</svg>`;
      }

      function renderCharts(daily){
        const ordered = daily.slice().sort((a,b)=>String(a.ymd||"").localeCompare(String(b.ymd||"")));
        const seriesNet  = ordered.map(x=>num(x.net));
        const seriesCash = ordered.map(x=>num(x.cash));
        $("chartNetWorth").innerHTML = sparkSVG(seriesNet);
        $("chartCash").innerHTML = sparkSVG(seriesCash);
      }

      function renderSnapshots(rows){
        const daily = rows.filter(r=>String(r.type||"").toLowerCase()==="daily");
        const weekly = rows.filter(r=>String(r.type||"").toLowerCase()==="weekly");

        const dT = $("dailyRows");
        dT.innerHTML = "";
        daily.slice(-30).reverse().forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(x.ymd || "")}</td>
            <td class="num">${money(num(x.burn))}</td>
            <td class="num">${money(num(x.income))}</td>
            <td class="num">${money(num(x.cash))}</td>
            <td class="num">${money(num(x.net))}</td>
            <td class="num">${isFinite(num(x.runway)) ? num(x.runway).toFixed(0) : "∞"}</td>
          `;
          dT.appendChild(tr);
        });

        const wT = $("weeklyRows");
        wT.innerHTML = "";
        weekly.slice(-26).reverse().forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(x.week || "")}</td>
            <td class="num">${money(num(x.burn))}</td>
            <td class="num">${money(num(x.income))}</td>
            <td class="num">${money(num(x.cash))}</td>
            <td class="num">${money(num(x.net))}</td>
            <td class="num">${isFinite(num(x.runway)) ? num(x.runway).toFixed(0) : "∞"}</td>
          `;
          wT.appendChild(tr);
        });

        renderCharts(daily);
      }

      function renderNotes(rows){
        const tbody = $("noteRows");
        tbody.innerHTML = "";
        rows.slice(-30).reverse().forEach(x=>{
          const ts = x.ts || "";
          const note = x.note || "";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${esc(String(ts))}</td><td>${esc(String(note)).replace(/\n/g,"<br>")}</td>`;
          tbody.appendChild(tr);
        });
      }

      async function pushState(state){
        setSync("SAVING…");
        showErr(false);
        const res = await apiPost("saveState", { state: buildSheetState(state) });
        if (res && res.ok){
          setSync("CONNECTED");
          $("lastUpdated").textContent = fmt(new Date());
        } else {
          setSync(res && res.error === "unauthorized" ? "LOCKED" : "ERROR");
          showErr(true);
          console.log("saveState failed:", res);
        }
      }

      async function addSnapshot(type, state, c){
        setSync("SAVING…");
        showErr(false);

        const snap = {
          type,
          ymd: ymd(new Date()),
          week: weekStartISO(new Date()),
          burn: c.burnTotal,
          income: state.avgIncome,
          cash: state.cash + state.inflow,
          net: c.netWorth,
          runway: c.runway1
        };

        const res = await apiPost("addSnapshot", { snapshot: snap });
        if (res && res.ok) setSync("CONNECTED");
        else {
          setSync(res && res.error === "unauthorized" ? "LOCKED" : "ERROR");
          showErr(true);
          console.log("addSnapshot failed:", res);
        }
      }

      function pullInputsIntoState(state){
        state.avgIncome   = num($("avgIncome").value);
        state.inflow      = num($("inflow").value);
        state.cash        = num($("cash").value);

        state.assetLiquid = num($("assetLiquid").value);
        state.assetOther  = num($("assetOther").value);
        state.liabDebt    = num($("liabDebt").value);

        const rows = state.rows;

        document.querySelectorAll("#rows .cat").forEach(inp=>{
          const i = +inp.dataset.idx;
          rows[i].cat = String(inp.value||"").trim();
        });
        document.querySelectorAll("#rows .item").forEach(inp=>{
          const i = +inp.dataset.idx;
          rows[i].item = String(inp.value||"").trim();
        });
        document.querySelectorAll("#rows .amt").forEach(inp=>{
          const i = +inp.dataset.idx;
          rows[i].amount = num(inp.value);
        });
        document.querySelectorAll("#rows .due").forEach(inp=>{
          const i = +inp.dataset.idx;
          rows[i].due = String(inp.value||"").trim();
        });
        document.querySelectorAll("#rows .note").forEach(inp=>{
          const i = +inp.dataset.idx;
          rows[i].notes = String(inp.value||"").trim();
        });
      }

      let state = null;
      let saveTimer = null;

      function scheduleSave(){
        if (!state) return;
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(async ()=>{
          pullInputsIntoState(state);
          renderCalc(state);
          await pushState(state);
        }, 450);
      }

      let wired = false;
      function wireOnce(){
        if (wired) return;
        wired = true;

        ["avgIncome","inflow","cash","assetLiquid","assetOther","liabDebt"].forEach(id=>{
          const el = $(id);
          if (!el) return;
          el.addEventListener("input", () => {
            if (!state) return;
            pullInputsIntoState(state);
            renderCalc(state);
            scheduleSave();
          });
          el.addEventListener("change", () => {
            if (!state) return;
            pullInputsIntoState(state);
            renderCalc(state);
            scheduleSave();
          });
        });

        $("rows").addEventListener("input", ()=>{
          if (!state) return;
          pullInputsIntoState(state);
          renderCalc(state);
          scheduleSave();
        });

        $("rows").addEventListener("change", ()=>{
          if (!state) return;
          pullInputsIntoState(state);
          renderCalc(state);
          scheduleSave();
        });

        $("rows").addEventListener("click", (e)=>{
          const btn = e.target;
          if (btn && btn.classList.contains("del")){
            const idx = +btn.dataset.idx;
            state.rows.splice(idx, 1);
            renderTable(state);
            enableUI(true);
            renderCalc(state);
            scheduleSave();
          }
        });

        $("addRow").addEventListener("click", ()=>{
          state.rows.push({cat:"", item:"", amount:0, due:"", notes:""});
          renderTable(state);
          enableUI(true);
          renderCalc(state);
          scheduleSave();
        });

        $("saveNow").addEventListener("click", async ()=>{
          pullInputsIntoState(state);
          renderCalc(state);
          await pushState(state);
        });

        $("snapDaily").addEventListener("click", async ()=>{
          pullInputsIntoState(state);
          const c = renderCalc(state);
          await addSnapshot("daily", state, c);
          const fresh = await apiGet("getAll");
          if (!fresh.error) renderSnapshots(fresh.snapshots || []);
        });

        $("snapWeekly").addEventListener("click", async ()=>{
          pullInputsIntoState(state);
          const c = renderCalc(state);
          await addSnapshot("weekly", state, c);
          const fresh = await apiGet("getAll");
          if (!fresh.error) renderSnapshots(fresh.snapshots || []);
        });

        $("saveNote").addEventListener("click", async ()=>{
          const text = ($("notes").value || "").trim();
          if (!text) return;

          setSync("SAVING…");
          showErr(false);

          const res = await apiPost("addNote", { note: text });
          if (!(res && res.ok)) {
            setSync(res && res.error === "unauthorized" ? "LOCKED" : "ERROR");
            showErr(true);
            console.log("addNote failed:", res);
            return;
          }

          $("notes").value = "";
          setSync("CONNECTED");

          const fresh = await apiGet("getAll");
          if (!fresh.error) renderNotes(fresh.notes || []);
        });

        $("logoutBtn").addEventListener("click", ()=>{
          sessionStorage.removeItem(TOKEN_KEY);
          window.location.replace("/burn.html");
        });
      }

      async function loadAll(){
        setSync("CONNECTING…");
        showErr(false);

        const data = await apiGet("getAll");

        if (data && data.error){
          setSync(data.error === "unauthorized" ? "LOCKED" : "ERROR");
          showErr(true);
          enableUI(false);

          if (data.error === "unauthorized") {
            sessionStorage.removeItem(TOKEN_KEY);
            window.location.replace("/burn.html");
          }
          return false;
        }

        setSync("CONNECTED");
        enableUI(true);
        wireOnce();

        const sheetStateObj = data.state || {};
        const empty = Object.keys(sheetStateObj).length === 0;

        state = empty ? JSON.parse(JSON.stringify(DEFAULT)) : parseState(sheetStateObj);

        $("avgIncome").value   = String(state.avgIncome.toFixed(2));
        $("inflow").value      = String(state.inflow.toFixed(2));
        $("cash").value        = String(state.cash.toFixed(2));

        $("assetLiquid").value = String(state.assetLiquid.toFixed(2));
        $("assetOther").value  = String(state.assetOther.toFixed(2));
        $("liabDebt").value    = String(state.liabDebt.toFixed(2));

        $("lastUpdated").textContent = state.updatedAt ? fmt(new Date(state.updatedAt)) : "—";

        renderTable(state);
        renderCalc(state);

        renderSnapshots(data.snapshots || []);
        renderNotes(data.notes || []);

        if (empty) await pushState(state);
        return true;
      }

      setInterval(()=>{
        const s = window.__burnCountdownSeconds;
        if (s == null || !isFinite(s)) return;
        window.__burnCountdownSeconds = Math.max(0, s - 1);
        const el = $("burnCountdown");
        if (el) el.textContent = secondsToDHMS(window.__burnCountdownSeconds);
      }, 1000);

      enableUI(false);
      loadAll();
    })();
  </script>
</body>
</html>
