<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Emanuel Payan | Burn</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  color: #eaeaea;
  font-family: "Courier New", monospace;
  font-size: 14px;
}

.wrap {
  padding: 20px;
  max-width: 1100px;
}

.title {
  margin-bottom: 14px;
  font-size: 16px;
}

.section {
  margin: 22px 0 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.6;
}

.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.grid {
  display: flex;
  gap: 40px;
  flex-wrap: wrap;
}

.block {
  min-width: 320px;
}

.mono {
  white-space: pre-wrap;
  line-height: 1.6;
}

a {
  color: #eaeaea;
  text-decoration: none;
}

.input,
select,
textarea {
  background: #000;
  color: #eaeaea;
  border: 1px solid #444;
  padding: 4px 6px;
  font-family: inherit;
  font-size: 14px;
}

.input.small { width: 120px; }
.input.tiny { width: 80px; }

.input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: #aaa;
}

.btn {
  background: #000;
  color: #eaeaea;
  border: 1px solid #444;
  padding: 4px 12px;
  font-family: inherit;
  cursor: pointer;
}

.btn:hover {
  border-color: #aaa;
}

table {
  border-collapse: collapse;
  width: 100%;
}

th, td {
  border: 1px solid #333;
  padding: 6px 8px;
  font-weight: normal;
}

th {
  opacity: 0.6;
  text-align: left;
}

td.num {
  text-align: right;
  white-space: nowrap;
}

td.center {
  text-align: center;
}

pre {
  margin: 0;
  border: 1px solid #333;
  padding: 10px;
}

.muted { opacity: 0.6; }
.blue { color: #6ea8ff; }
.bad { color: #ff5555; }
</style>
</head>

<body>
<div class="wrap">
  <div class="title">Emanuel Payan | Burn</div>

  <div class="row">
    <a href="/burn">Back</a>
    <span class="muted">|</span>
    SYNC: <span class="blue" id="sync">CONNECTING…</span>
    <span class="muted">|</span>
    <button class="btn" id="logoutBtn">LOGOUT</button>
  </div>

  <div class="section">Inputs</div>
  <div class="grid">
    <div class="block mono">
Avg Net Monthly Income : <input class="input" id="avgIncome">
One-Time Inflow        : <input class="input" id="inflow">
Cash on Hand           : <input class="input" id="cash">
    </div>

    <div class="block mono">
Total Monthly Burn     : <span class="blue" id="burnTotal">—</span>
Left / Month           : <span class="blue" id="leftMo">—</span>
Daily Burn             : <span class="blue" id="daily">—</span>
Runway (days)          : <span class="blue" id="runway">—</span>
    </div>
  </div>

  <div class="section">Line Items</div>
  <div class="row">
    <button class="btn" id="addRow">ADD</button>
    <button class="btn" id="saveNow">SAVE</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>CATEGORY</th>
        <th>ITEM</th>
        <th class="num">AMOUNT</th>
        <th>DUE</th>
        <th>NOTES</th>
        <th>X</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="section">Notes</div>
  <textarea id="notes" rows="4"></textarea>
  <div class="row" style="margin-top:8px;">
    <button class="btn" id="saveNote">SAVE NOTE</button>
  </div>

  <div class="section">Note History</div>
  <table>
    <thead>
      <tr>
        <th>TIME</th>
        <th>NOTE</th>
      </tr>
    </thead>
    <tbody id="noteRows"></tbody>
  </table>
</div>

<script>
(() => {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHUYAzQBNE5qQXOs07z7Gg_d78qZOb4WNCirHBeJOSSRcOMMx-NxWqHTTzTZOvFmjo3w/exec";
  const TOKEN_KEY = "emanuel_burn_token_session";
  const $ = id => document.getElementById(id);

  // hard auth check
  if (!sessionStorage.getItem(TOKEN_KEY)) {
    location.href = "/burn";
    return;
  }

  $("logoutBtn").onclick = () => {
    sessionStorage.removeItem(TOKEN_KEY);
    location.href = "/burn";
  };

  const num = x => isFinite(+x) ? +x : 0;
  const money = n => "$" + n.toFixed(2);

  async function api(action, payload = {}) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        action,
        token: sessionStorage.getItem(TOKEN_KEY),
        ...payload
      })
    });
    return res.json();
  }

  function renderCalc(state) {
    const burn = state.rows.reduce((s,r)=>s+num(r.amount),0);
    $("burnTotal").textContent = money(burn);
    $("leftMo").textContent = money(state.avgIncome - burn);
    $("daily").textContent = money(burn / 30.4);
    $("runway").textContent =
      burn > 0 ? ((state.cash + state.inflow)/(burn/30.4)).toFixed(0) : "∞";
  }

  function renderRows(rows){
    const tbody = $("rows");
    tbody.innerHTML = "";
    rows.forEach((r,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="input" data-i="${i}" data-k="cat" value="${r.cat||""}"></td>
        <td><input class="input" data-i="${i}" data-k="item" value="${r.item||""}"></td>
        <td class="num"><input class="input small" data-i="${i}" data-k="amount" value="${num(r.amount).toFixed(2)}"></td>
        <td><input class="input tiny" data-i="${i}" data-k="due" value="${r.due||""}"></td>
        <td><input class="input" data-i="${i}" data-k="notes" value="${r.notes||""}"></td>
        <td class="center"><button class="btn del" data-i="${i}">X</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function load(){
    const data = await api("getAll");
    $("sync").textContent = "CONNECTED";

    const s = data.state || {};
    const rows = JSON.parse(s.rowsJson || "[]");

    $("avgIncome").value = s.avgIncome || "0";
    $("inflow").value = s.inflow || "0";
    $("cash").value = s.cash || "0";

    const state = {
      avgIncome: num(s.avgIncome),
      inflow: num(s.inflow),
      cash: num(s.cash),
      rows
    };

    renderRows(rows);
    renderCalc(state);
  }

  $("rows").addEventListener("input", e=>{
    const i = e.target.dataset.i;
    const k = e.target.dataset.k;
    if (i == null) return;
  });

  $("rows").addEventListener("click", e=>{
    if (!e.target.classList.contains("del")) return;
    const i = +e.target.dataset.i;
    current.rows.splice(i,1);
    renderRows(current.rows);
    renderCalc(current);
  });

  $("addRow").onclick = ()=>{
    current.rows.push({cat:"",item:"",amount:0,due:"",notes:""});
    renderRows(current.rows);
  };

  let current = { avgIncome:0, inflow:0, cash:0, rows:[] };
  load();
})();
</script>
</body>
</html>
