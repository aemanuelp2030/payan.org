<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Burn | Emanuel Payan</title>

<style>
  html, body{
    margin:0;
    height:100%;
    background:#000;
    color:#fff;
    font-family: Chicago, Geneva, Monaco, "Courier New", monospace;
    font-size:15px;
  }
  .wrap{ padding:20px; }
  .title{ margin-bottom:10px; letter-spacing:.5px; }
  .meta{ margin-bottom:14px; line-height:1.6; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .section{ margin:16px 0 8px; }
  .grid{ display:flex; gap:40px; flex-wrap:wrap; }
  .block{ min-width:320px; }
  .mono{ white-space:pre-wrap; line-height:1.6; }
  .blue{ color:#007BFF; }
  .muted{ opacity:.85; }

  a{ color:#fff; text-decoration:none; }

  .input{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
    width:170px;
  }
  .input.small{ width:120px; }

  .btn{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 10px;
    font-family:inherit;
    font-size:15px;
    cursor:pointer;
  }

  select, textarea{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    font-family:inherit;
    font-size:15px;
  }

  textarea{ width:100%; padding:8px; }

  table{
    border-collapse:collapse;
    width:100%;
  }
  th, td{
    border:1px solid #fff;
    padding:6px 8px;
    font-weight:normal;
  }
  td.num{ text-align:right; }
</style>
</head>

<body>
<div class="wrap">
  <div class="title">Emanuel Payan | Burn</div>

  <div class="meta">
    <div class="row">
      <a href="index.html">Back</a> |
      SYNC: <span class="blue" id="sync">LOCKED</span> |
      <button class="btn" id="loginBtn">LOGIN</button>
      <button class="btn" id="logoutBtn" style="display:none;">LOGOUT</button>
      <span id="err" class="muted" style="display:none;">| ERROR</span>
    </div>
    LAST UPDATED: <span class="blue" id="lastUpdated">â€”</span><br>
    INCLUDE SAUL IN BURN:
    <select id="includeSaul" disabled>
      <option value="yes">YES</option>
      <option value="no">NO</option>
    </select>
  </div>

  <div class="section">Inputs</div>
  <div class="grid mono">
    <div>
Avg Net Monthly Income : <input class="input" id="avgIncome" disabled>
One-Time Inflow (Saul) : <input class="input" id="inflow" disabled>
Cash on Hand (ref)    : <input class="input" id="cash" disabled>
    </div>

    <div>
Total Monthly Burn    : <span class="blue" id="burnTotal">â€”</span>
Left / mo             : <span class="blue" id="leftMo">â€”</span>
Daily Burn            : <span class="blue" id="daily">â€”</span>
Weekly Burn           : <span class="blue" id="weekly">â€”</span>
Burn / Year           : <span class="blue" id="yearly">â€”</span>
Runway (after inflow) : <span class="blue" id="runway1">â€”</span> days
    </div>
  </div>

  <div class="section">Notes</div>
  <button class="btn" id="saveNote" disabled>SAVE NOTE</button>
  <textarea id="notes" rows="6" disabled></textarea>

  <div class="section">Note History</div>
  <table>
    <thead><tr><th>TIME</th><th>NOTE</th></tr></thead>
    <tbody id="noteRows"></tbody>
  </table>
</div>

<script>
(() => {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHUYAzQBNE5qQXOs07z7Gg_d78qZOb4WNCirHBeJOSSRcOMMx-NxWqHTTzTZOvFmjo3w/exec";
  const TOKEN_KEY = "emanuel_burn_token_session";
  const $ = id => document.getElementById(id);

  const token = () => sessionStorage.getItem(TOKEN_KEY) || "";

  const money = n => isFinite(n) ? "$" + n.toFixed(2) : "â€”";
  const fmt = d => d.toISOString().replace("T"," ").slice(0,19);

  function setSync(t){ $("sync").textContent = t; }
  function showErr(v){ $("err").style.display = v ? "" : "none"; }

  async function apiGet(action){
    const r = await fetch(`${SCRIPT_URL}?action=${action}&token=${encodeURIComponent(token())}`);
    return r.json();
  }

  // ðŸ”‘ CORS-SAFE POST (NO HEADERS)
  async function apiPost(action, payload){
    const r = await fetch(SCRIPT_URL,{
      method:"POST",
      body: JSON.stringify({ action, token: token(), ...payload })
    });
    return r.json();
  }

  function enable(on){
    ["includeSaul","avgIncome","inflow","cash","notes","saveNote"]
      .forEach(id => $(id).disabled = !on);
  }

  function renderNotes(rows){
    const t = $("noteRows");
    t.innerHTML = "";
    rows.slice(-20).reverse().forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.ts||""}</td><td>${(r.note||"").replace(/\n/g,"<br>")}</td>`;
      t.appendChild(tr);
    });
  }

  async function load(){
    setSync("CONNECTINGâ€¦");
    const data = await apiGet("getAll");
    if (data.error){
      setSync("LOCKED");
      enable(false);
      return;
    }

    enable(true);
    setSync("CONNECTED");
    renderNotes(data.notes||[]);
  }

  $("saveNote").onclick = async ()=>{
    const text = $("notes").value.trim();
    if (!text) return;

    setSync("SAVINGâ€¦");
    const r = await apiPost("addNote",{ note:text });
    if (r.ok){
      $("notes").value = "";
      setSync("CONNECTED");
      const fresh = await apiGet("getAll");
      renderNotes(fresh.notes||[]);
    } else {
      setSync("ERROR");
      showErr(true);
    }
  };

  $("loginBtn").onclick = async ()=>{
    const p = prompt("PASSCODE:");
    if (!p) return;
    sessionStorage.setItem(TOKEN_KEY,p);
    $("loginBtn").style.display="none";
    $("logoutBtn").style.display="";
    await load();
  };

  $("logoutBtn").onclick = ()=>{
    sessionStorage.removeItem(TOKEN_KEY);
    location.reload();
  };

  if (token()){
    $("loginBtn").style.display="none";
    $("logoutBtn").style.display="";
  }

  load();
})();
</script>
</body>
</html>

