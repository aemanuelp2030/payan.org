<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Burn | Emanuel Payan</title>

<style>
  html, body{
    margin:0;
    height:100%;
    background:#000;
    color:#fff;
    font-family: Chicago, Geneva, Monaco, "Courier New", monospace;
    font-size:15px;
  }
  .wrap{ padding:20px; }
  .title{ margin-bottom:10px; font-weight:normal; letter-spacing:.5px; }
  .meta{ margin-bottom:14px; line-height:1.6; opacity:.95; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .section{ margin:16px 0 8px; letter-spacing:.3px; }
  .grid{ display:flex; gap:40px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; }
  .block{ min-width:320px; }
  .mono{ white-space:pre-wrap; line-height:1.6; }
  .blue{ color:#007BFF; }
  .muted{ opacity:.85; }

  a{ color:#fff; text-decoration:none; }

  .input{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
    width:170px;
    box-sizing:border-box;
  }
  .input.small{ width:120px; }

  .btn{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 10px;
    font-family:inherit;
    font-size:15px;
    cursor:pointer;
  }

  select{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
  }

  textarea{
    width:100%;
    background:#000;
    color:#fff;
    border:1px solid #fff;
    font-family:inherit;
    font-size:15px;
    padding:8px;
    box-sizing:border-box;
  }

  table{
    border-collapse:collapse;
    width:100%;
    max-width:1100px;
  }
  th, td{
    border:1px solid #fff;
    padding:6px 8px;
    vertical-align:top;
    font-weight:normal;
  }
  th{ text-align:left; }
  td.num{ text-align:right; white-space:nowrap; }
  td.notes{ width:30%; }

  pre{
    margin:0;
    border:1px solid #fff;
    padding:10px;
    overflow:auto;
    max-width:1100px;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="title">Emanuel Payan | Burn</div>

  <div class="meta">
    <div class="row">
      <a href="index.html">Back</a>
      <span class="muted">|</span>
      <button class="btn" id="loginBtn">LOGIN</button>
      <button class="btn" id="logoutBtn" style="display:none;">LOGOUT</button>
      <span class="muted">|</span>
      SYNC: <span class="blue" id="sync">DISCONNECTED</span>
    </div>
    LAST UPDATED: <span class="blue" id="lastUpdated">—</span><br>
    INCLUDE SAUL IN BURN:
    <select id="includeSaul" disabled>
      <option value="yes">YES</option>
      <option value="no">NO</option>
    </select>
  </div>

  <div class="section">Inputs</div>
  <div class="grid">
    <div class="block mono">
Avg Net Monthly Income : <input class="input" id="avgIncome" value="3464.00" disabled>
One-Time Inflow (Saul) : <input class="input" id="inflow" value="3000.00" disabled>
Cash on Hand (ref)     : <input class="input" id="cash" value="2578.89" disabled>
    </div>

    <div class="block mono">
Total Monthly Burn     : <span class="blue" id="burnTotal">—</span>
Left / mo              : <span class="blue" id="leftMo">—</span>
Daily Burn             : <span class="blue" id="daily">—</span>
Weekly Burn            : <span class="blue" id="weekly">—</span>
Burn / Year            : <span class="blue" id="yearly">—</span>
Runway (after inflow)  : <span class="blue" id="runway1">—</span> days
    </div>
  </div>

  <div class="section">Upcoming Due (14d)</div>
  <pre class="mono" id="dueList">—</pre>

  <div class="section">Line Items</div>
  <table>
    <thead>
      <tr>
        <th style="width:14%;">CATEGORY</th>
        <th style="width:26%;">ITEM</th>
        <th style="width:12%;">AMOUNT</th>
        <th style="width:12%;">DUE</th>
        <th style="width:26%;">NOTES</th>
        <th style="width:10%;">AS</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="section">Snapshots</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="snapDaily" disabled>DAILY</button>
    <button class="btn" id="snapWeekly" disabled>WEEKLY</button>
    <span class="muted">Saved to Google Sheets.</span>
  </div>

  <div class="grid">
    <div class="block">
      <div class="muted" style="margin-bottom:6px;">DAILY</div>
      <table>
        <thead>
          <tr>
            <th>DATE</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="dailyRows"></tbody>
      </table>
    </div>

    <div class="block">
      <div class="muted" style="margin-bottom:6px;">WEEKLY</div>
      <table>
        <thead>
          <tr>
            <th>WEEK</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="weeklyRows"></tbody>
      </table>
    </div>
  </div>

  <div class="section">Notes</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="saveNote" disabled>SAVE NOTE</button>
    <span class="muted">Saved to Google Sheets.</span>
  </div>
  <textarea rows="6" id="notes" disabled></textarea>

  <div class="section">Note History</div>
  <table>
    <thead>
      <tr>
        <th style="width:22%;">TIME</th>
        <th>NOTE</th>
      </tr>
    </thead>
    <tbody id="noteRows"></tbody>
  </table>
</div>

<script>
(() => {
  // PASTE YOUR APPS SCRIPT WEB APP URL HERE (must end with /exec)
  const SCRIPT_URL = "const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHUYAzQBNE5qQXOs07z7Gg_d78qZOb4WNCirHBeJOSSRcOMMx-NxWqHTTzTZOvFmjo3w/exec";
";

  const TOKEN_KEY = "emanuel_burn_token_session";
  const $ = (id) => document.getElementById(id);

  const money = (n) => (isFinite(n) ? "$" + n.toFixed(2) : "—");
  const pad2 = (x) => String(x).padStart(2,"0");
  const ymd = (d) => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  const fmt = (d) => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+
    " "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
  function weekStartISO(d){
    const x = new Date(d);
    const day = (x.getDay()+6)%7; // Mon=0
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return ymd(x);
  }

  function setSync(text){ $("sync").textContent = text; }
  function enableUI(on){
    ["includeSaul","avgIncome","inflow","cash","snapDaily","snapWeekly","saveNote","notes"].forEach(id=>{
      $(id).disabled = !on;
    });
    $("loginBtn").style.display = on ? "none" : "";
    $("logoutBtn").style.display = on ? "" : "none";
  }

  async function apiGet(action){
    const token = sessionStorage.getItem(TOKEN_KEY) || "";
    const url = `${SCRIPT_URL}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(token)}`;
    const res = await fetch(url, { cache: "no-cache" });
    return await res.json();
  }
  async function apiPost(action, payload){
    const token = sessionStorage.getItem(TOKEN_KEY) || "";
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ action, token, ...payload })
    });
    return await res.json();
  }

  const DEFAULT = {
    includeSaul: "yes",
    avgIncome: 3464.00,
    inflow: 3000.00,
    cash: 2578.89,
    rows: [
      {cat:"INCOME", item:"Hourly Wage", amount:20.00, due:"", notes:"40 hrs/week", as:"ignore"},
      {cat:"INCOME", item:"Avg Net Monthly Income", amount:3464.00, due:"", notes:"Conservative base job", as:"ignore"},
      {cat:"INCOME", item:"One-Time Inflow (Saul)", amount:3000.00, due:"25", notes:"Hits on 25th (non-recurring)", as:"ignore"},

      {cat:"LIVING", item:"Housing - Rent", amount:800.00, due:"01", notes:"Due 1st", as:"you"},
      {cat:"LIVING", item:"Internet", amount:20.00, due:"", notes:"Monthly", as:"you"},
      {cat:"LIVING", item:"Food", amount:650.00, due:"", notes:"Monthly", as:"you"},

      {cat:"TRANSPORTATION", item:"Gas", amount:250.00, due:"", notes:"Monthly", as:"you"},
      {cat:"TRANSPORTATION", item:"Car Payment #1", amount:369.89, due:"11", notes:"Due 11th", as:"you"},
      {cat:"TRANSPORTATION", item:"Car Payment #2", amount:285.98, due:"17", notes:"Due 17th", as:"you"},

      {cat:"FAMILY AID", item:"Discover Card (Saul)", amount:50.00, due:"10", notes:"Due 10th", as:"saul"},
      {cat:"FAMILY AID", item:"Capital One (Saul)", amount:75.00, due:"22", notes:"Due 22nd", as:"saul"},
      {cat:"FAMILY AID", item:"Apple Card (Saul)", amount:257.16, due:"EOM", notes:"End of month", as:"saul"}
    ],
    notes: ""
  };

  function parseStateFromSheet(sheetState){
    const out = {};
    out.includeSaul = (sheetState.includeSaul || DEFAULT.includeSaul);
    out.avgIncome = +(sheetState.avgIncome ?? DEFAULT.avgIncome);
    out.inflow = +(sheetState.inflow ?? DEFAULT.inflow);
    out.cash = +(sheetState.cash ?? DEFAULT.cash);
    try { out.rows = JSON.parse(sheetState.rowsJson || "null") || DEFAULT.rows; }
    catch { out.rows = DEFAULT.rows; }
    out.notes = String(sheetState.notes || DEFAULT.notes);
    out.updatedAt = sheetState.updatedAt || "";
    return out;
  }

  function buildStateForSheet(state){
    return {
      includeSaul: state.includeSaul,
      avgIncome: String(state.avgIncome),
      inflow: String(state.inflow),
      cash: String(state.cash),
      rowsJson: JSON.stringify(state.rows),
      notes: state.notes,
      updatedAt: new Date().toISOString()
    };
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function renderTable(state){
    const tbody = $("rows");
    tbody.innerHTML = "";
    state.rows.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.cat}</td>
        <td>${r.item}</td>
        <td class="num"><input class="input small amt" data-idx="${idx}" value="${Number(r.amount||0)}"></td>
        <td><input class="input small due" data-idx="${idx}" placeholder="DD / MM-DD / EOM" value="${r.due||""}"></td>
        <td class="notes">${escapeHtml(r.notes||"")}</td>
        <td>
          <select data-idx="${idx}" class="as">
            <option value="you">YOU</option>
            <option value="saul">SAUL</option>
            <option value="ignore">-</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector("select.as").value = (r.as || "you");
    });
  }

  function endOfMonthDate(d){
    const x = new Date(d.getFullYear(), d.getMonth()+1, 0);
    x.setHours(0,0,0,0);
    return x;
  }

  function parseDueToDate(dueStr, now){
    const s = String(dueStr || "").trim();
    if (!s) return null;

    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const dt = new Date(s + "T00:00:00");
      return isNaN(dt.getTime()) ? null : dt;
    }
    if (s.toUpperCase() === "EOM") return endOfMonthDate(now);

    if (/^\d{2}-\d{2}$/.test(s)){
      const [mm, dd] = s.split("-").map(Number);
      if (!mm || !dd) return null;
      let dt = new Date(now.getFullYear(), mm-1, dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear()+1, mm-1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }

    if (/^\d{1,2}$/.test(s)){
      const dd = Number(s);
      if (!dd) return null;
      let dt = new Date(now.getFullYear(), now.getMonth(), dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear(), now.getMonth()+1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }
    return null;
  }

  function renderDueList(state){
    const el = $("dueList");
    const now = new Date();
    const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const horizon = new Date(today0);
    horizon.setDate(horizon.getDate() + 14);

    const includeSaul = state.includeSaul !== "no";

    const upcoming = state.rows
      .map(r => ({ r, dueDate: parseDueToDate(r.due, now) }))
      .filter(x => x.dueDate && x.dueDate >= today0 && x.dueDate <= horizon)
      .filter(x => includeSaul ? true : x.r.as !== "saul")
      .filter(x => x.r.as !== "ignore")
      .sort((a,b)=>a.dueDate-b.dueDate);

    if (!upcoming.length){ el.textContent = "—"; return; }

    el.textContent = upcoming.map(x=>{
      const d = x.dueDate;
      const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      const who = x.r.as === "saul" ? "SAUL" : "YOU";
      return `${ds}  ${money(+x.r.amount||0)}  ${who}  ${x.r.item}`;
    }).join("\n");
  }

  function calcAndRender(state){
    const includeSaul = state.includeSaul !== "no";
    let burnYou = 0, burnSaul = 0;

    state.rows.forEach(r=>{
      const a = (+r.amount||0);
      if (r.as === "you") burnYou += a;
      else if (r.as === "saul") burnSaul += a;
    });

    const burnTotal = burnYou + (includeSaul ? burnSaul : 0);
    const leftMo = state.avgIncome - burnTotal;

    const daily = burnTotal / 30.437;
    const weekly = daily * 7;
    const yearly = burnTotal * 12;

    const cashAfter = state.cash + state.inflow;
    const runway1 = daily > 0 ? (cashAfter / daily) : Infinity;

    $("burnTotal").textContent = money(burnTotal);
    $("leftMo").textContent = money(leftMo);
    $("daily").textContent = money(daily);
    $("weekly").textContent = money(weekly);
    $("yearly").textContent = money(yearly);
    $("runway1").textContent = isFinite(runway1) ? runway1.toFixed(0) : "∞";

    renderDueList(state);

    return { burnTotal, cashAfter, runway1 };
  }

  function renderSnapshots(rows){
    const daily = rows.filter(r=>String(r.type||"").toLowerCase()==="daily");
    const weekly = rows.filter(r=>String(r.type||"").toLowerCase()==="weekly");

    const dT = $("dailyRows");
    dT.innerHTML = "";
    daily.slice(-30).reverse().forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.ymd || ""}</td>
        <td class="num">${money(+x.burn||0)}</td>
        <td class="num">${money(+x.income||0)}</td>
        <td class="num">${money(+x.cash||0)}</td>
        <td class="num">${isFinite(+x.runway) ? (+x.runway).toFixed(0) : "∞"}</td>
      `;
      dT.appendChild(tr);
    });

    const wT = $("weeklyRows");
    wT.innerHTML = "";
    weekly.slice(-26).reverse().forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.week || ""}</td>
        <td class="num">${money(+x.burn||0)}</td>
        <td class="num">${money(+x.income||0)}</td>
        <td class="num">${money(+x.cash||0)}</td>
        <td class="num">${isFinite(+x.runway) ? (+x.runway).toFixed(0) : "∞"}</td>
      `;
      wT.appendChild(tr);
    });
  }

  function renderNotes(rows){
    const tbody = $("noteRows");
    tbody.innerHTML = "";
    rows.slice(-20).reverse().forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(String(x.ts||""))}</td><td>${escapeHtml(String(x.note||"")).replace(/\n/g,"<br>")}</td>`;
      tbody.appendChild(tr);
    });
  }

  function hydrateUI(state){
    $("includeSaul").value = (state.includeSaul === "no" ? "no" : "yes");
    $("avgIncome").value = String(state.avgIncome);
    $("inflow").value = String(state.inflow);
    $("cash").value = String(state.cash);
    $("notes").value = state.notes || "";
    $("lastUpdated").textContent = state.updatedAt ? fmt(new Date(state.updatedAt)) : "—";
    renderTable(state);
    calcAndRender(state);
  }

  function pullInputsIntoState(state){
    state.includeSaul = $("includeSaul").value === "no" ? "no" : "yes";
    state.avgIncome = +$("avgIncome").value || 0;
    state.inflow = +$("inflow").value || 0;
    state.cash = +$("cash").value || 0;
    state.notes = $("notes").value || "";

    document.querySelectorAll("input.amt").forEach(inp=>{
      const idx = +inp.dataset.idx;
      state.rows[idx].amount = (+inp.value || 0);
    });
    document.querySelectorAll("input.due").forEach(inp=>{
      const idx = +inp.dataset.idx;
      state.rows[idx].due = String(inp.value || "").trim();
    });
    document.querySelectorAll("select.as").forEach(sel=>{
      const idx = +sel.dataset.idx;
      state.rows[idx].as = sel.value;
    });
  }

  let state = null;
  let saveTimer = null;

  async function loadAll(){
    setSync("CONNECTING…");
    const data = await apiGet("getAll");
    if (data && data.error){
      setSync("UNAUTHORIZED");
      enableUI(false);
      return null;
    }
    setSync("CONNECTED");
    enableUI(true);
    return data;
  }

  async function pushState(){
    if (!state) return;
    setSync("SAVING…");
    const res = await apiPost("saveState", { state: buildStateForSheet(state) });
    if (res && res.ok){
      setSync("CONNECTED");
      $("lastUpdated").textContent = fmt(new Date());
    } else {
      setSync("SAVE FAILED");
    }
  }

  function scheduleSave(){
    if (!state) return;
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      pullInputsIntoState(state);
      calcAndRender(state);
      await pushState();
    }, 450);
  }

  async function addSnapshot(type){
    if (!state) return;
    pullInputsIntoState(state);
    const c = calcAndRender(state);
    setSync("SAVING…");
    const snap = {
      type,
      ymd: ymd(new Date()),
      week: weekStartISO(new Date()),
      burn: c.burnTotal,
      income: state.avgIncome,
      cash: state.cash + state.inflow,
      runway: c.runway1,
      includeSaul: state.includeSaul
    };
    const res = await apiPost("addSnapshot", { snapshot: snap });
    if (!(res && res.ok)){ setSync("SAVE FAILED"); return; }
    const fresh = await loadAll();
    if (fresh) renderSnapshots(fresh.snapshots || []);
  }

  async function saveNote(){
    if (!state) return;
    const text = ($("notes").value || "").trim();
    if (!text) return;
    setSync("SAVING…");
    const res = await apiPost("addNote", { note: text });
    if (!(res && res.ok)){ setSync("SAVE FAILED"); return; }
    const fresh = await loadAll();
    if (fresh) renderNotes(fresh.notes || []);
  }

  async function login(){
    const token = prompt("Passphrase:");
    if (!token) return;
    sessionStorage.setItem(TOKEN_KEY, token);

    const data = await loadAll();
    if (!data) return;

    const sheetStateObj = data.state || {};
    const empty = Object.keys(sheetStateObj).length === 0;

    state = parseStateFromSheet(sheetStateObj);

    if (empty){
      state = JSON.parse(JSON.stringify(DEFAULT));
      await pushState();
      const fresh = await loadAll();
      if (fresh){
        state = parseStateFromSheet(fresh.state || {});
        hydrateUI(state);
        renderSnapshots(fresh.snapshots || []);
        renderNotes(fresh.notes || []);
      }
      return;
    }

    hydrateUI(state);
    renderSnapshots(data.snapshots || []);
    renderNotes(data.notes || []);
  }

  function logout(){
    sessionStorage.removeItem(TOKEN_KEY);
    state = null;
    enableUI(false);
    setSync("DISCONNECTED");
    $("lastUpdated").textContent = "—";
  }

  // Wire UI (works after login)
  ["includeSaul","avgIncome","inflow","cash","notes"].forEach(id=>{
    $(id).addEventListener("input", scheduleSave);
    $(id).addEventListener("change", scheduleSave);
  });
  $("rows").addEventListener("input", (e)=>{
    if (!e.target) return;
    if (e.target.classList.contains("amt") || e.target.classList.contains("due") || e.target.classList.contains("as")) scheduleSave();
  });
  $("rows").addEventListener("change", (e)=>{
    if (!e.target) return;
    if (e.target.classList.contains("amt") || e.target.classList.contains("due") || e.target.classList.contains("as")) scheduleSave();
  });

  $("snapDaily").addEventListener("click", ()=>addSnapshot("daily"));
  $("snapWeekly").addEventListener("click", ()=>addSnapshot("weekly"));
  $("saveNote").addEventListener("click", saveNote);

  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", logout);

  // If token already exists in session, auto-login
  if (sessionStorage.getItem(TOKEN_KEY)) login();
})();
</script>
</body>
</html>
