<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Burn | Emanuel Payan</title>

<style>
  html, body{
    margin:0;
    height:100%;
    background:#000;
    color:#fff;
    font-family: Chicago, Geneva, Monaco, "Courier New", monospace;
    font-size:15px;
  }
  .wrap{ padding:20px; }
  .title{ margin-bottom:10px; font-weight:normal; letter-spacing:.5px; }
  .meta{ margin-bottom:14px; line-height:1.6; opacity:.9; }
  .section{ margin:16px 0 8px; letter-spacing:.3px; }
  .grid{ display:flex; gap:40px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; }
  .block{ min-width:320px; }
  .mono{ white-space:pre-wrap; line-height:1.6; }
  .blue{ color:#007BFF; }

  a{ color:#fff; text-decoration:none; }

  .input{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
    width:160px;
    box-sizing:border-box;
  }
  .input.small{ width:110px; }

  .btn{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 10px;
    font-family:inherit;
    font-size:15px;
    cursor:pointer;
  }

  table{
    border-collapse:collapse;
    width:100%;
    max-width:1100px;
  }
  th, td{
    border:1px solid #fff;
    padding:6px 8px;
    vertical-align:top;
    font-weight:normal;
  }
  th{ text-align:left; }
  td.num{ text-align:right; white-space:nowrap; }
  td.notes{ width:30%; }

  select{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
  }

  textarea{
    width:100%;
    background:#000;
    color:#fff;
    border:1px solid #fff;
    font-family:inherit;
    font-size:15px;
    padding:8px;
    box-sizing:border-box;
  }

  pre{
    margin:0;
    border:1px solid #fff;
    padding:10px;
    overflow:auto;
    max-width:1100px;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .muted{ opacity:.85; }
</style>
</head>

<body>
<div class="wrap">
  <div class="title">Emanuel Payan | Burn</div>

  <div class="meta">
    <a href="index.html">Back</a><br>
    LAST UPDATED: <span class="blue" id="lastUpdated">—</span><br>
    SYNC: <span class="blue" id="sync">CONNECTING…</span><br>
    INCLUDE SAUL IN BURN:
    <select id="includeSaul">
      <option value="yes">YES</option>
      <option value="no">NO</option>
    </select>
  </div>

  <div class="section">Inputs</div>
  <div class="grid">
    <div class="block mono">
Avg Net Monthly Income : <input class="input" id="avgIncome" value="3464.00">
One-Time Inflow (Saul) : <input class="input" id="inflow" value="3000.00">
Cash on Hand (ref)     : <input class="input" id="cash" value="2578.89">
    </div>

    <div class="block mono">
Total Monthly Burn     : <span class="blue" id="burnTotal">—</span>
Left / mo              : <span class="blue" id="leftMo">—</span>
Daily Burn             : <span class="blue" id="daily">—</span>
Runway (after inflow)  : <span class="blue" id="runway1">—</span> days
    </div>
  </div>

  <div class="section">Upcoming Due (14d)</div>
  <pre class="mono" id="dueList">—</pre>

  <div class="section">Line Items</div>
  <table>
    <thead>
      <tr>
        <th style="width:14%;">CATEGORY</th>
        <th style="width:26%;">ITEM</th>
        <th style="width:12%;">AMOUNT</th>
        <th style="width:12%;">DUE</th>
        <th style="width:26%;">NOTES</th>
        <th style="width:10%;">AS</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="section">Snapshots</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="snapDaily">DAILY</button>
    <button class="btn" id="snapWeekly">WEEKLY</button>
    <span class="muted">Saved to Google Sheets.</span>
  </div>

  <div class="grid">
    <div class="block">
      <div class="muted" style="margin-bottom:6px;">DAILY</div>
      <table>
        <thead>
          <tr>
            <th>DATE</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="dailyRows"></tbody>
      </table>
    </div>

    <div class="block">
      <div class="muted" style="margin-bottom:6px;">WEEKLY</div>
      <table>
        <thead>
          <tr>
            <th>WEEK</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="weeklyRows"></tbody>
      </table>
    </div>
  </div>

  <div class="section">Notes</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="saveNote">SAVE NOTE</button>
    <span class="muted">Saved to Google Sheets.</span>
  </div>
  <textarea rows="6" id="notes"></textarea>

  <div class="section">Note History</div>
  <table>
    <thead>
      <tr>
        <th style="width:22%;">TIME</th>
        <th>NOTE</th>
      </tr>
    </thead>
    <tbody id="noteRows"></tbody>
  </table>
</div>

<script>
(() => {
  // 1) PASTE your Apps Script web app URL here:
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzs8ZqaqXqXm3fkZs8jfJ6vogCTTK0e9I7d2ebdZtgB-EyC-muj7ffvLYSZRDIeRn_9ig/exec";

  // Token is NOT hardcoded. It’s asked once per session.
  const TOKEN_KEY = "emanuel_burn_token_session";

  const $ = (id) => document.getElementById(id);
  const money = (n) => (isFinite(n) ? "$" + n.toFixed(2) : "—");
  const pad2 = (x) => String(x).padStart(2,"0");
  const ymd = (d) => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  const fmt = (d) => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+
    " "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());

  function weekStartISO(d){
    const x = new Date(d);
    const day = (x.getDay()+6)%7; // Mon=0
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return ymd(x);
  }

  async function apiGet(action){
    const token = sessionStorage.getItem(TOKEN_KEY) || "";
    const url = `${SCRIPT_URL}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(token)}`;
    const res = await fetch(url, { cache: "no-cache" });
    return await res.json();
  }

  async function apiPost(action, payload){
    const token = sessionStorage.getItem(TOKEN_KEY) || "";
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, token, ...payload })
    });
    return await res.json();
  }

  function ensureToken(){
    let t = sessionStorage.getItem(TOKEN_KEY);
    if (t) return t;
    t = prompt("Burn passphrase:");
    if (!t) return "";
    sessionStorage.setItem(TOKEN_KEY, t);
    return t;
  }

  // Minimal default (only used if sheet is empty)
  const DEFAULT = {
    includeSaul: "yes",
    avgIncome: 3464.00,
    inflow: 3000.00,
    cash: 2578.89,
    rows: [
      {cat:"LIVING", item:"Housing - Rent", amount:800.00, due:"01", notes:"Due 1st", as:"you"},
      {cat:"LIVING", item:"Internet", amount:20.00, due:"", notes:"Monthly", as:"you"},
      {cat:"LIVING", item:"Food", amount:650.00, due:"", notes:"Monthly", as:"you"},
      {cat:"TRANSPORT", item:"Gas", amount:250.00, due:"", notes:"Monthly", as:"you"},
      {cat:"TRANSPORT", item:"Car Payment #1", amount:369.89, due:"11", notes:"Due 11th", as:"you"},
      {cat:"TRANSPORT", item:"Car Payment #2", amount:285.98, due:"17", notes:"Due 17th", as:"you"},
      {cat:"FAMILY", item:"Discover (Saul)", amount:50.00, due:"10", notes:"Due 10th", as:"saul"},
      {cat:"FAMILY", item:"Capital One (Saul)", amount:75.00, due:"22", notes:"Due 22nd", as:"saul"},
      {cat:"FAMILY", item:"Apple Card (Saul)", amount:257.16, due:"EOM", notes:"End of month", as:"saul"}
    ],
    notes: ""
  };

  function parseStateFromSheet(sheetState){
    // sheetState is a map key->value stored in the "state" tab
    // store JSON blobs in a couple keys to keep it simple
    const out = {};
    out.includeSaul = (sheetState.includeSaul || DEFAULT.includeSaul);
    out.avgIncome = +(sheetState.avgIncome ?? DEFAULT.avgIncome);
    out.inflow = +(sheetState.inflow ?? DEFAULT.inflow);
    out.cash = +(sheetState.cash ?? DEFAULT.cash);

    try { out.rows = JSON.parse(sheetState.rowsJson || "null") || DEFAULT.rows; }
    catch { out.rows = DEFAULT.rows; }

    out.notes = String(sheetState.notes || DEFAULT.notes);
    out.updatedAt = sheetState.updatedAt || "";
    return out;
  }

  function buildStateForSheet(state){
    return {
      includeSaul: state.includeSaul,
      avgIncome: String(state.avgIncome),
      inflow: String(state.inflow),
      cash: String(state.cash),
      rowsJson: JSON.stringify(state.rows),
      notes: state.notes,
      updatedAt: new Date().toISOString()
    };
  }

  function renderTable(state){
    const tbody = $("rows");
    tbody.innerHTML = "";

    state.rows.forEach((r, idx)=>{
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.cat}</td>
        <td>${r.item}</td>
        <td class="num"><input class="input small amt" data-idx="${idx}" value="${Number(r.amount||0)}"></td>
        <td><input class="input small due" data-idx="${idx}" placeholder="DD / MM-DD / EOM" value="${r.due||""}"></td>
        <td class="notes">${r.notes||""}</td>
        <td>
          <select data-idx="${idx}" class="as">
            <option value="you">YOU</option>
            <option value="saul">SAUL</option>
            <option value="ignore">-</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector("select.as").value = (r.as || "you");
    });
  }

  function endOfMonthDate(d){
    const x = new Date(d.getFullYear(), d.getMonth()+1, 0);
    x.setHours(0,0,0,0);
    return x;
  }

  function parseDueToDate(dueStr, now){
    const s = String(dueStr || "").trim();
    if (!s) return null;

    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const dt = new Date(s + "T00:00:00");
      return isNaN(dt.getTime()) ? null : dt;
    }
    if (s.toUpperCase() === "EOM") return endOfMonthDate(now);

    if (/^\d{2}-\d{2}$/.test(s)){
      const [mm, dd] = s.split("-").map(Number);
      if (!mm || !dd) return null;
      let dt = new Date(now.getFullYear(), mm-1, dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear()+1, mm-1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }

    if (/^\d{1,2}$/.test(s)){
      const dd = Number(s);
      if (!dd) return null;
      let dt = new Date(now.getFullYear(), now.getMonth(), dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear(), now.getMonth()+1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }
    return null;
  }

  function renderDueList(state){
    const el = $("dueList");
    const now = new Date();
    const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const horizon = new Date(today0);
    horizon.setDate(horizon.getDate() + 14);

    const includeSaul = state.includeSaul !== "no";

    const upcoming = state.rows
      .map(r => ({ r, dueDate: parseDueToDate(r.due, now) }))
      .filter(x => x.dueDate && x.dueDate >= today0 && x.dueDate <= horizon)
      .filter(x => includeSaul ? true : x.r.as !== "saul")
      .filter(x => x.r.as !== "ignore")
      .sort((a,b)=>a.dueDate-b.dueDate);

    if (!upcoming.length){ el.textContent = "—"; return; }

    el.textContent = upcoming.map(x=>{
      const d = x.dueDate;
      const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      const who = x.r.as === "saul" ? "SAUL" : "YOU";
      return `${ds}  ${money(+x.r.amount||0)}  ${who}  ${x.r.item}`;
    }).join("\n");
  }

  function calcAndRender(state){
    const includeSaul = state.includeSaul !== "no";
    let burnYou = 0, burnSaul = 0;

    state.rows.forEach(r=>{
      const a = (+r.amount||0);
      if (r.as === "you") burnYou += a;
      else if (r.as === "saul") burnSaul += a;
    });

    const burnTotal = burnYou + (includeSaul ? burnSaul : 0);
    const leftMo = state.avgIncome - burnTotal;
    const daily = burnTotal / 30.437;

    const cashAfter = state.cash + state.inflow;
    const runway1 = daily > 0 ? (cashAfter / daily) : Infinity;

    $("burnTotal").textContent = money(burnTotal);
    $("leftMo").textContent = money(leftMo);
    $("daily").textContent = money(daily);
    $("runway1").textContent = isFinite(runway1) ? runway1.toFixed(0) : "∞";

    renderDueList(state);

    return { burnTotal, cashAfter, runway1 };
  }

  function renderSnapshots(rows){
    const daily = rows.filter(r=>String(r.type||"").toLowerCase()==="daily");
    const weekly = rows.filter(r=>String(r.type||"").toLowerCase()==="weekly");

    const dT = $("dailyRows");
    dT.innerHTML = "";
    daily.slice().reverse().slice(-30).reverse().forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.ymd || ""}</td>
        <td class="num">${money(+x.burn||0)}</td>
        <td class="num">${money(+x.income||0)}</td>
        <td class="num">${money(+x.cash||0)}</td>
        <td class="num">${isFinite(+x.runway) ? (+x.runway).toFixed(0) : "∞"}</td>
      `;
      dT.appendChild(tr);
    });

    const wT = $("weeklyRows");
    wT.innerHTML = "";
    weekly.slice().reverse().slice(-26).reverse().forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.week || ""}</td>
        <td class="num">${money(+x.burn||0)}</td>
        <td class="num">${money(+x.income||0)}</td>
        <td class="num">${money(+x.cash||0)}</td>
        <td class="num">${isFinite(+x.runway) ? (+x.runway).toFixed(0) : "∞"}</td>
      `;
      wT.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function renderNotes(rows){
    const tbody = $("noteRows");
    tbody.innerHTML = "";
    rows.slice().reverse().slice(-20).reverse().forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${String(x.ts||"")}</td><td>${escapeHtml(String(x.note||"")).replace(/\n/g,"<br>")}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadAll(){
    $("sync").textContent = "CONNECTING…";
    const token = ensureToken();
    if (!token){
      $("sync").textContent = "NO TOKEN";
      return null;
    }

    const data = await apiGet("getAll");
    if (data.error){
      $("sync").textContent = "UNAUTHORIZED";
      return null;
    }
    $("sync").textContent = "CONNECTED";
    return data;
  }

  async function pushState(state){
    $("sync").textContent = "SAVING…";
    const res = await apiPost("saveState", { state: buildStateForSheet(state) });
    if (res && res.ok){
      $("sync").textContent = "CONNECTED";
      $("lastUpdated").textContent = fmt(new Date());
    } else {
      $("sync").textContent = "SAVE FAILED";
    }
  }

  async function addSnapshot(type, state, calcOut){
    const snap = {
      type,
      ymd: ymd(new Date()),
      week: weekStartISO(new Date()),
      burn: calcOut.burnTotal,
      income: state.avgIncome,
      cash: state.cash + state.inflow,
      runway: calcOut.runway1,
      includeSaul: state.includeSaul
    };
    $("sync").textContent = "SAVING…";
    const res = await apiPost("addSnapshot", { snapshot: snap });
    $("sync").textContent = (res && res.ok) ? "CONNECTED" : "SAVE FAILED";
  }

  async function addNote(text){
    $("sync").textContent = "SAVING…";
    const res = await apiPost("addNote", { note: text });
    $("sync").textContent = (res && res.ok) ? "CONNECTED" : "SAVE FAILED";
  }

  // ===== MAIN =====
  (async function boot(){
    const data = await loadAll();
    if (!data) return;

    // If sheet is empty, initialize once
    const sheetStateObj = data.state || {};
    const isEmpty = Object.keys(sheetStateObj).length === 0;

    let state = parseStateFromSheet(sheetStateObj);

    if (isEmpty){
      state = {...DEFAULT};
      await pushState(state);
    }

    // hydrate UI
    $("includeSaul").value = (state.includeSaul === "no" ? "no" : "yes");
    $("avgIncome").value = String(state.avgIncome);
    $("inflow").value = String(state.inflow);
    $("cash").value = String(state.cash);
    $("notes").value = state.notes || "";

    // last updated line
    $("lastUpdated").textContent = state.updatedAt ? fmt(new Date(state.updatedAt)) : "—";

    renderTable(state);
    const calcOut = calcAndRender(state);
    renderSnapshots(data.snapshots || []);
    renderNotes(data.notes || []);

    function pullInputsIntoState(){
      state.includeSaul = $("includeSaul").value === "no" ? "no" : "yes";
      state.avgIncome = +$("avgIncome").value || 0;
      state.inflow = +$("inflow").value || 0;
      state.cash = +$("cash").value || 0;
      state.notes = $("notes").value || "";

      // table values
      document.querySelectorAll("input.amt").forEach(inp=>{
        const idx = +inp.dataset.idx;
        state.rows[idx].amount = (+inp.value || 0);
      });
      document.querySelectorAll("input.due").forEach(inp=>{
        const idx = +inp.dataset.idx;
        state.rows[idx].due = String(inp.value || "").trim();
      });
      document.querySelectorAll("select.as").forEach(sel=>{
        const idx = +sel.dataset.idx;
        state.rows[idx].as = sel.value;
      });
    }

    let saveTimer = null;
    function scheduleSave(){
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async ()=>{
        pullInputsIntoState();
        calcAndRender(state);
        await pushState(state);
      }, 450);
    }

    ["includeSaul","avgIncome","inflow","cash","notes"].forEach(id=>{
      $(id).addEventListener("input", scheduleSave);
      $(id).addEventListener("change", scheduleSave);
    });

    $("rows").addEventListener("input", (e)=>{
      if (!e.target) return;
      if (e.target.classList.contains("amt") || e.target.classList.contains("due") || e.target.classList.contains("as")) scheduleSave();
    });
    $("rows").addEventListener("change", (e)=>{
      if (!e.target) return;
      if (e.target.classList.contains("amt") || e.target.classList.contains("due") || e.target.classList.contains("as")) scheduleSave();
    });

    $("snapDaily").addEventListener("click", async ()=>{
      pullInputsIntoState();
      const c = calcAndRender(state);
      await addSnapshot("daily", state, c);
      const fresh = await loadAll();
      if (fresh) renderSnapshots(fresh.snapshots || []);
    });

    $("snapWeekly").addEventListener("click", async ()=>{
      pullInputsIntoState();
      const c = calcAndRender(state);
      await addSnapshot("weekly", state, c);
      const fresh = await loadAll();
      if (fresh) renderSnapshots(fresh.snapshots || []);
    });

    $("saveNote").addEventListener("click", async ()=>{
      const text = ($("notes").value || "").trim();
      if (!text) return;
      await addNote(text);
      const fresh = await loadAll();
      if (fresh) renderNotes(fresh.notes || []);
    });
  })();
})();
</script>
</body>
</html>
