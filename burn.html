<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Burn | Emanuel Payan</title>

<style>
  html, body{
    margin:0;
    height:100%;
    background:#000;
    color:#fff;
    font-family: Chicago, Geneva, Monaco, "Courier New", monospace;
    font-size:15px;
  }
  .wrap{ padding:20px; }
  .title{ margin-bottom:10px; font-weight:normal; letter-spacing:.5px; }
  .meta{ margin-bottom:14px; line-height:1.6; opacity:.9; }
  .section{ margin:16px 0 8px; letter-spacing:.3px; }
  .grid{ display:flex; gap:40px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; }
  .block{ min-width:320px; }
  .mono{ white-space:pre-wrap; line-height:1.6; }
  .blue{ color:#007BFF; }

  a{
    color:#fff;
    text-decoration:none;
  }

  .input{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
    width:160px;
    box-sizing:border-box;
  }
  .input.small{ width:110px; }

  .btn{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 10px;
    font-family:inherit;
    font-size:15px;
    cursor:pointer;
  }

  table{
    border-collapse:collapse;
    width:100%;
    max-width:1100px;
  }
  th, td{
    border:1px solid #fff;
    padding:6px 8px;
    vertical-align:top;
    font-weight:normal;
  }
  th{ text-align:left; }
  td.num{ text-align:right; white-space:nowrap; }
  td.notes{ width:30%; }

  select{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
  }

  textarea{
    width:100%;
    background:#000;
    color:#fff;
    border:1px solid #fff;
    font-family:inherit;
    font-size:15px;
    padding:8px;
    box-sizing:border-box;
  }

  pre{
    margin:0;
    border:1px solid #fff;
    padding:10px;
    overflow:auto;
    max-width:1100px;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .muted{ opacity:.85; }
</style>
</head>

<body>
<div class="wrap">
  <div class="title">Emanuel Payan | Burn</div>

  <div class="meta">
    <a href="index.html">Back</a><br>
    LAST UPDATED: <span class="blue" id="lastUpdated">—</span><br>
    INCLUDE SAUL IN BURN:
    <select id="includeSaul">
      <option value="yes">YES</option>
      <option value="no">NO</option>
    </select>
  </div>

  <div class="section">Inputs</div>
  <div class="grid">
    <div class="block mono">
Avg Net Monthly Income : <input class="input" id="avgIncome" value="3464.00">
One-Time Inflow (Saul) : <input class="input" id="inflow" value="3000.00">
Cash on Hand (ref)     : <input class="input" id="cash" value="2578.89">
    </div>

    <div class="block mono">
Total Monthly Burn     : <span class="blue" id="burnTotal">—</span>
Left / mo              : <span class="blue" id="leftMo">—</span>
Daily Burn             : <span class="blue" id="daily">—</span>
Runway (after inflow)  : <span class="blue" id="runway1">—</span> days
    </div>
  </div>

  <div class="section">Upcoming Due (14d)</div>
  <pre class="mono" id="dueList">—</pre>

  <div class="section">Line Items</div>
  <table>
    <thead>
      <tr>
        <th style="width:14%;">CATEGORY</th>
        <th style="width:26%;">ITEM</th>
        <th style="width:12%;">AMOUNT</th>
        <th style="width:12%;">DUE</th>
        <th style="width:26%;">NOTES</th>
        <th style="width:10%;">AS</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="section">Snapshots</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="snapDaily">DAILY</button>
    <button class="btn" id="snapWeekly">WEEKLY</button>
    <button class="btn" id="clearSnaps">CLEAR</button>
    <span class="muted">Auto daily: 1 per day when you open the page.</span>
  </div>

  <div class="grid">
    <div class="block">
      <div class="muted" style="margin-bottom:6px;">DAILY (30)</div>
      <table>
        <thead>
          <tr>
            <th>DATE</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="dailyRows"></tbody>
      </table>
    </div>

    <div class="block">
      <div class="muted" style="margin-bottom:6px;">WEEKLY (26)</div>
      <table>
        <thead>
          <tr>
            <th>WEEK</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="weeklyRows"></tbody>
      </table>
    </div>
  </div>

  <div class="section">Trajectory</div>
  <pre class="mono" id="traj">—</pre>

  <div class="section">Notes</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="saveNote">SAVE</button>
    <button class="btn" id="clearNotes">CLEAR</button>
    <span class="muted">Textbox saves automatically.</span>
  </div>
  <textarea rows="6" id="notes"></textarea>

  <div class="section">Note History (20)</div>
  <table>
    <thead>
      <tr>
        <th style="width:22%;">TIME</th>
        <th>NOTE</th>
      </tr>
    </thead>
    <tbody id="noteRows"></tbody>
  </table>
</div>

<script>
(() => {
  const KEY = "emanuel_burn_state_v1";
  const NOTES_KEY = "emanuel_burn_notes_v1";
  const NOTE_HISTORY_KEY = "emanuel_burn_note_history_v1";
  const SNAP_KEY = "emanuel_burn_snapshots_v1";

  const $ = (id) => document.getElementById(id);
  const money = (n) => (isFinite(n) ? "$" + n.toFixed(2) : "—");

  function pad2(x){ return String(x).padStart(2,"0"); }
  function ymd(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
  function fmt(d){
    return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+
      " "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
  }
  function weekStartISO(d){
    const x = new Date(d);
    const day = (x.getDay()+6)%7; // Mon=0
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return ymd(x);
  }

  const DEFAULT = {
    includeSaul: "yes",
    inputs: { avgIncome: 3464.00, inflow: 3000.00, cash: 2578.89 },
    rows: [
      {cat:"LIVING", item:"Housing - Rent", amount:800.00, due:"01", notes:"Due 1st", countsAs:"you"},
      {cat:"LIVING", item:"Internet", amount:20.00, due:"", notes:"Monthly", countsAs:"you"},
      {cat:"LIVING", item:"Food", amount:650.00, due:"", notes:"Monthly", countsAs:"you"},

      {cat:"TRANSPORT", item:"Gas", amount:250.00, due:"", notes:"Monthly", countsAs:"you"},
      {cat:"TRANSPORT", item:"Car Payment #1", amount:369.89, due:"11", notes:"Due 11th", countsAs:"you"},
      {cat:"TRANSPORT", item:"Car Payment #2", amount:285.98, due:"17", notes:"Due 17th", countsAs:"you"},

      {cat:"FAMILY", item:"Discover (Saul)", amount:50.00, due:"10", notes:"Due 10th", countsAs:"saul"},
      {cat:"FAMILY", item:"Capital One (Saul)", amount:75.00, due:"22", notes:"Due 22nd", countsAs:"saul"},
      {cat:"FAMILY", item:"Apple Card (Saul)", amount:257.16, due:"EOM", notes:"End of month", countsAs:"saul"}
    ],
    lastUpdatedISO: null
  };

  function clone(x){ return JSON.parse(JSON.stringify(x)); }

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return clone(DEFAULT);
      const s = JSON.parse(raw);
      return {
        includeSaul: (s.includeSaul === "no" ? "no" : "yes"),
        inputs: {...DEFAULT.inputs, ...(s.inputs||{})},
        rows: Array.isArray(s.rows) ? s.rows : clone(DEFAULT.rows),
        lastUpdatedISO: s.lastUpdatedISO || null
      };
    }catch{
      return clone(DEFAULT);
    }
  }
  function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function markUpdated(state){
    state.lastUpdatedISO = new Date().toISOString();
    $("lastUpdated").textContent = fmt(new Date(state.lastUpdatedISO));
  }
  function setLastUpdated(state){
    if(state.lastUpdatedISO){
      const d = new Date(state.lastUpdatedISO);
      $("lastUpdated").textContent = isNaN(d.getTime()) ? "—" : fmt(d);
    } else $("lastUpdated").textContent = "—";
  }

  function renderTable(state){
    const tbody = $("rows");
    tbody.innerHTML = "";

    state.rows.forEach((r, idx) => {
      const tr = document.createElement("tr");

      const tdCat = document.createElement("td");
      tdCat.textContent = r.cat;

      const tdItem = document.createElement("td");
      tdItem.textContent = r.item;

      const tdAmt = document.createElement("td");
      tdAmt.className = "num";
      const amt = document.createElement("input");
      amt.className = "input small amt";
      amt.value = (r.amount ?? 0);
      amt.dataset.idx = String(idx);
      tdAmt.appendChild(amt);

      const tdDue = document.createElement("td");
      const due = document.createElement("input");
      due.className = "input small due";
      due.placeholder = "DD / MM-DD / EOM";
      due.value = (r.due ?? "");
      due.dataset.idx = String(idx);
      tdDue.appendChild(due);

      const tdNotes = document.createElement("td");
      tdNotes.className = "notes";
      tdNotes.textContent = r.notes || "";

      const tdWho = document.createElement("td");
      const sel = document.createElement("select");
      sel.dataset.idx = String(idx);
      [
        ["you","YOU"],
        ["saul","SAUL"],
        ["ignore","-"]
      ].forEach(([v, label])=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = label;
        if((r.countsAs||"you") === v) o.selected = true;
        sel.appendChild(o);
      });
      tdWho.appendChild(sel);

      tr.append(tdCat, tdItem, tdAmt, tdDue, tdNotes, tdWho);
      tbody.appendChild(tr);
    });
  }

  // ===== Due list =====
  function endOfMonthDate(d){
    const x = new Date(d.getFullYear(), d.getMonth()+1, 0);
    x.setHours(0,0,0,0);
    return x;
  }

  function parseDueToDate(dueStr, now){
    const s = String(dueStr || "").trim();
    if (!s) return null;

    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const dt = new Date(s + "T00:00:00");
      return isNaN(dt.getTime()) ? null : dt;
    }
    // EOM
    if (s.toUpperCase() === "EOM"){
      return endOfMonthDate(now);
    }
    // MM-DD
    if (/^\d{2}-\d{2}$/.test(s)){
      const [mm, dd] = s.split("-").map(Number);
      if (!mm || !dd) return null;
      let dt = new Date(now.getFullYear(), mm-1, dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear()+1, mm-1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }
    // DD
    if (/^\d{1,2}$/.test(s)){
      const dd = Number(s);
      if (!dd) return null;
      let dt = new Date(now.getFullYear(), now.getMonth(), dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear(), now.getMonth()+1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }
    return null;
  }

  function renderDueList(state){
    const el = $("dueList");
    const now = new Date();
    const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const horizon = new Date(today0);
    horizon.setDate(horizon.getDate() + 14);

    const includeSaul = $("includeSaul").value !== "no";

    const upcoming = state.rows
      .map(r => ({ r, dueDate: parseDueToDate(r.due, now) }))
      .filter(x => x.dueDate && x.dueDate >= today0 && x.dueDate <= horizon)
      .filter(x => includeSaul ? true : x.r.countsAs !== "saul")
      .filter(x => x.r.countsAs !== "ignore")
      .sort((a,b) => a.dueDate - b.dueDate);

    if (!upcoming.length){
      el.textContent = "—";
      return;
    }

    el.textContent = upcoming.map(x => {
      const d = x.dueDate;
      const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      const who = x.r.countsAs === "saul" ? "SAUL" : "YOU";
      return `${ds}  ${money(+x.r.amount||0)}  ${who}  ${x.r.item}`;
    }).join("\n");
  }

  // ===== Snapshots =====
  function loadSnaps(){
    try{
      return JSON.parse(localStorage.getItem(SNAP_KEY) || '{"daily":[],"weekly":[],"lastDailyYMD":null}');
    }catch{
      return {daily:[], weekly:[], lastDailyYMD:null};
    }
  }
  function saveSnaps(s){ localStorage.setItem(SNAP_KEY, JSON.stringify(s)); }

  function snapshotPayload(calcOut){
    return {
      ts: new Date().toISOString(),
      ymd: ymd(new Date()),
      week: weekStartISO(new Date()),
      burn: calcOut.burnTotal,
      income: calcOut.incomeMo,
      cash: calcOut.cashAfter,
      runway: calcOut.runwayAfter,
      includeSaul: calcOut.includeSaul
    };
  }

  function addDailySnapshot(calcOut){
    const s = loadSnaps();
    const today = ymd(new Date());
    s.daily.unshift(snapshotPayload(calcOut));
    s.daily = s.daily.slice(0,30);
    s.lastDailyYMD = today;
    saveSnaps(s);
    renderSnapshots();
  }

  function addWeeklySnapshot(calcOut){
    const s = loadSnaps();
    s.weekly.unshift(snapshotPayload(calcOut));
    s.weekly = s.weekly.slice(0,26);
    saveSnaps(s);
    renderSnapshots();
  }

  function autoDailySnapshot(calcOut){
    const s = loadSnaps();
    const today = ymd(new Date());
    if (s.lastDailyYMD !== today){
      addDailySnapshot(calcOut);
    }
  }

  function renderSnapshots(){
    const s = loadSnaps();

    const dailyT = $("dailyRows");
    dailyT.innerHTML = "";
    s.daily.forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.ymd}</td>
        <td class="num">${money(+x.burn||0)}</td>
        <td class="num">${money(+x.income||0)}</td>
        <td class="num">${money(+x.cash||0)}</td>
        <td class="num">${isFinite(x.runway)? (+x.runway).toFixed(0) : "∞"}</td>
      `;
      dailyT.appendChild(tr);
    });

    const weeklyT = $("weeklyRows");
    weeklyT.innerHTML = "";
    s.weekly.forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.week}</td>
        <td class="num">${money(+x.burn||0)}</td>
        <td class="num">${money(+x.income||0)}</td>
        <td class="num">${money(+x.cash||0)}</td>
        <td class="num">${isFinite(x.runway)? (+x.runway).toFixed(0) : "∞"}</td>
      `;
      weeklyT.appendChild(tr);
    });

    renderTrajectoryASCII(s);
  }

  function bar(value, min, max, width){
    if (!isFinite(value) || max <= min) return " ".repeat(width);
    const t = (value - min) / (max - min);
    const n = Math.max(0, Math.min(width, Math.round(t * width)));
    return "█".repeat(n) + " ".repeat(width - n);
  }

  function renderTrajectoryASCII(s){
    const daily = (s.daily || []).slice(0,14).reverse();
    const burnVals = daily.map(x=>+x.burn).filter(isFinite);
    const cashVals = daily.map(x=>+x.cash).filter(isFinite);
    const burnMin = Math.min(...burnVals, 0), burnMax = Math.max(...burnVals, 1);
    const cashMin = Math.min(...cashVals, 0), cashMax = Math.max(...cashVals, 1);

    if (!daily.length){
      $("traj").textContent = "—";
      return;
    }

    let out = "DATE       BURN                    CASH\n";
    daily.forEach(x=>{
      const b = bar(+x.burn, burnMin, burnMax, 20);
      const c = bar(+x.cash, cashMin, cashMax, 20);
      out += `${x.ymd}  ${b}  ${c}\n`;
    });
    $("traj").textContent = out.trimEnd();
  }

  // ===== Notes =====
  function loadNoteHistory(){
    try{ return JSON.parse(localStorage.getItem(NOTE_HISTORY_KEY) || "[]"); }
    catch{ return []; }
  }
  function saveNoteHistory(arr){
    localStorage.setItem(NOTE_HISTORY_KEY, JSON.stringify(arr));
  }
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function renderNoteHistory(){
    const arr = loadNoteHistory();
    const tbody = $("noteRows");
    tbody.innerHTML = "";
    arr.slice(0,20).forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${x.ts}</td><td>${escapeHtml(x.text).replace(/\n/g,"<br>")}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ===== Core calc =====
  function calc(state){
    const includeSaul = state.includeSaul === "yes";

    const avgIncome = +$("avgIncome").value || 0;
    const inflow = +$("inflow").value || 0;
    const cash = +$("cash").value || 0;

    // sync table inputs back into state
    document.querySelectorAll("input.amt").forEach(inp=>{
      const idx = +inp.dataset.idx;
      state.rows[idx].amount = (+inp.value || 0);
    });
    document.querySelectorAll("input.due").forEach(inp=>{
      const idx = +inp.dataset.idx;
      state.rows[idx].due = String(inp.value || "").trim();
    });
    document.querySelectorAll("tbody#rows select").forEach(sel=>{
      const idx = +sel.dataset.idx;
      state.rows[idx].countsAs = sel.value;
    });

    let burnYou = 0, burnSaul = 0;
    state.rows.forEach(r=>{
      const a = (+r.amount || 0);
      if (r.countsAs === "you") burnYou += a;
      else if (r.countsAs === "saul") burnSaul += a;
    });

    const burnTotal = burnYou + (includeSaul ? burnSaul : 0);
    const leftMo = avgIncome - burnTotal;

    const daily = burnTotal / 30.437;
    const cashAfter = cash + inflow;
    const runway1 = daily > 0 ? (cashAfter / daily) : Infinity;

    // UI
    $("burnTotal").textContent = money(burnTotal);
    $("leftMo").textContent = money(leftMo);
    $("daily").textContent = money(daily);
    $("runway1").textContent = isFinite(runway1) ? runway1.toFixed(0) : "∞";

    // persist inputs
    state.inputs.avgIncome = avgIncome;
    state.inputs.inflow = inflow;
    state.inputs.cash = cash;

    saveState(state);

    return {
      includeSaul,
      incomeMo: avgIncome,
      burnTotal,
      cashAfter,
      runwayAfter: runway1
    };
  }

  // ===== Boot =====
  const state = loadState();

  $("avgIncome").value = String(state.inputs.avgIncome ?? 0);
  $("inflow").value = String(state.inputs.inflow ?? 0);
  $("cash").value = String(state.inputs.cash ?? 0);

  $("includeSaul").value = state.includeSaul || "yes";
  setLastUpdated(state);

  renderTable(state);

  // Notes autosave
  $("notes").value = localStorage.getItem(NOTES_KEY) || "";
  $("notes").addEventListener("input", () => {
    localStorage.setItem(NOTES_KEY, $("notes").value);
  });

  $("saveNote").addEventListener("click", () => {
    const text = ($("notes").value || "").trim();
    if (!text) return;
    const arr = loadNoteHistory();
    arr.unshift({ ts: fmt(new Date()), text });
    saveNoteHistory(arr.slice(0,20));
    renderNoteHistory();
  });

  $("clearNotes").addEventListener("click", () => {
    localStorage.removeItem(NOTE_HISTORY_KEY);
    renderNoteHistory();
  });

  renderNoteHistory();

  function onAnyChange(){
    markUpdated(state);
    state.includeSaul = $("includeSaul").value === "no" ? "no" : "yes";
    const out = calc(state);
    renderDueList(state);
    renderSnapshots();
    return out;
  }

  // inputs
  ["avgIncome","inflow","cash","includeSaul"].forEach(id=>{
    $(id).addEventListener("input", onAnyChange);
    $(id).addEventListener("change", onAnyChange);
  });

  // table input events
  $("rows").addEventListener("input", (e) => {
    if (!e.target) return;
    if (e.target.classList.contains("amt") || e.target.classList.contains("due") || e.target.tagName === "SELECT") onAnyChange();
  });
  $("rows").addEventListener("change", (e) => {
    if (!e.target) return;
    if (e.target.classList.contains("amt") || e.target.classList.contains("due") || e.target.tagName === "SELECT") onAnyChange();
  });

  // initial
  state.includeSaul = $("includeSaul").value === "no" ? "no" : "yes";
  const out0 = calc(state);
  renderDueList(state);
  renderSnapshots();
  autoDailySnapshot(out0);

  // snapshot buttons
  $("snapDaily").addEventListener("click", () => addDailySnapshot(calc(state)));
  $("snapWeekly").addEventListener("click", () => addWeeklySnapshot(calc(state)));
  $("clearSnaps").addEventListener("click", () => {
    localStorage.removeItem(SNAP_KEY);
    renderSnapshots();
  });

})();
</script>
</body>
</html>
