<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Emanuel Payan | Burn</title>

<style>
  html, body{
    margin:0;
    height:100%;
    background:#000;
    color:#fff;
    font-family: Chicago, Geneva, Monaco, "Courier New", monospace;
    font-size:15px;
  }
  .wrap{ padding:20px; max-width:1200px; }
  .title{ margin-bottom:10px; letter-spacing:.5px; font-weight:normal; }
  .meta{ margin-bottom:14px; line-height:1.6; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .section{ margin:18px 0 8px; }
  .grid{ display:flex; gap:40px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; }
  .block{ min-width:320px; }
  .mono{ white-space:pre-wrap; line-height:1.6; }
  .blue{ color:#007BFF; }
  .muted{ opacity:.85; }
  .bad{ color:#f33; }

  a{ color:#fff; text-decoration:none; }

  .input{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 6px;
    font-family:inherit;
    font-size:15px;
    width:180px;
    box-sizing:border-box;
  }
  .input.small{ width:120px; }
  .input.tiny{ width:80px; }

  .btn{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    padding:4px 10px;
    font-family:inherit;
    font-size:15px;
    cursor:pointer;
  }

  select, textarea{
    background:#000;
    color:#fff;
    border:1px solid #fff;
    font-family:inherit;
    font-size:15px;
  }
  textarea{ width:100%; padding:8px; box-sizing:border-box; }

  table{
    border-collapse:collapse;
    width:100%;
    max-width:1200px;
  }
  th, td{
    border:1px solid #fff;
    padding:6px 8px;
    vertical-align:top;
    font-weight:normal;
  }
  th{ text-align:left; }
  td.num{ text-align:right; white-space:nowrap; }
  td.center{ text-align:center; }

  pre{
    margin:0;
    border:1px solid #fff;
    padding:10px;
    overflow:auto;
  }

  .chart{
    border:1px solid #fff;
    padding:10px;
    max-width:1200px;
    overflow:auto;
  }
  .chart-title{ margin-bottom:8px; }

  /* BLANK BEFORE LOGIN */
  #app{ display:none; }
  #gate{ display:block; }
</style>
</head>

<body>

<!-- GATE (only visible before login / on error) -->
<div class="wrap" id="gate">
  <div class="title">Emanuel Payan | Burn</div>
  <div class="row">
    <a href="index.html">Back</a>
    <span class="muted">|</span>
    <button class="btn" id="loginBtnGate">LOGIN</button>
    <span class="muted" id="gateErr" style="display:none;">| <span class="bad">ERROR</span> (console)</span>
  </div>
  <div class="row" style="margin-top:10px;">
    <span class="bad" id="gateMsg" style="display:none;"></span>
  </div>
</div>

<!-- APP (hidden until login succeeds) -->
<div class="wrap" id="app">
  <div class="title">Emanuel Payan | Burn</div>

  <div class="meta">
    <div class="row">
      <a href="index.html">Back</a>
      <span class="muted">|</span>
      SYNC: <span class="blue" id="sync">LOCKED</span>
      <span class="muted">|</span>
      <button class="btn" id="logoutBtn">LOGOUT</button>
      <span class="muted" id="err" style="display:none;">| <span class="bad">ERROR</span> (console)</span>
    </div>

    LAST UPDATED: <span class="blue" id="lastUpdated">—</span><br>
    INCLUDE SAUL IN BURN:
    <select id="includeSaul" disabled>
      <option value="yes">YES</option>
      <option value="no">NO</option>
    </select>
  </div>

  <div class="section">Inputs</div>
  <div class="grid">
    <div class="block mono">
Avg Net Monthly Income : <input class="input" id="avgIncome" value="3464.00" disabled>
One-Time Inflow (Saul) : <input class="input" id="inflow" value="3000.00" disabled>
Cash on Hand (ref)     : <input class="input" id="cash" value="2578.89" disabled>
    </div>

    <div class="block mono">
Total Monthly Burn     : <span class="blue" id="burnTotal">—</span>
Left / mo              : <span class="blue" id="leftMo">—</span>
Income:Expense Ratio   : <span class="blue" id="ratio">—</span>
Daily Burn             : <span class="blue" id="daily">—</span>
Weekly Burn            : <span class="blue" id="weekly">—</span>
Burn / Year            : <span class="blue" id="yearly">—</span>
Runway (after inflow)  : <span class="blue" id="runway1">—</span> days
Burn countdown         : <span class="blue" id="burnCountdown">—</span>
    </div>
  </div>

  <div class="section">Net Worth</div>
  <div class="grid">
    <div class="block mono">
Assets (Liquid)        : <input class="input" id="assetLiquid" value="5578.89" disabled>
Assets (Other)         : <input class="input" id="assetOther" value="0.00" disabled>
Liabilities (Debt)     : <input class="input" id="liabDebt" value="0.00" disabled>
    </div>

    <div class="block mono">
Net Worth               : <span class="blue" id="netWorth">—</span>
30d Projection          : <span class="blue" id="nw30">—</span>
90d Projection          : <span class="blue" id="nw90">—</span>
365d Projection         : <span class="blue" id="nw365">—</span>
    </div>
  </div>

  <div class="section">Upcoming Due (14d)</div>
  <pre class="mono" id="dueList">—</pre>

  <div class="section">Line Items</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="addRow" disabled>ADD LINE</button>
    <button class="btn" id="saveNow" disabled>SAVE NOW</button>
    <span class="muted">Autosaves after edits.</span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:14%;">CATEGORY</th>
        <th style="width:28%;">ITEM</th>
        <th style="width:12%;">AMOUNT</th>
        <th style="width:12%;">DUE</th>
        <th style="width:22%;">NOTES</th>
        <th style="width:8%;">AS</th>
        <th style="width:4%;">X</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="section">Snapshots</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="snapDaily" disabled>DAILY</button>
    <button class="btn" id="snapWeekly" disabled>WEEKLY</button>
    <span class="muted">Saved to Google Sheets.</span>
  </div>

  <div class="grid">
    <div class="block">
      <div class="muted" style="margin-bottom:6px;">DAILY (last 30)</div>
      <table>
        <thead>
          <tr>
            <th>DATE</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">NET</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="dailyRows"></tbody>
      </table>
    </div>

    <div class="block">
      <div class="muted" style="margin-bottom:6px;">WEEKLY (last 26)</div>
      <table>
        <thead>
          <tr>
            <th>WEEK</th>
            <th class="num">BURN</th>
            <th class="num">INCOME</th>
            <th class="num">CASH</th>
            <th class="num">NET</th>
            <th class="num">RUNWAY</th>
          </tr>
        </thead>
        <tbody id="weeklyRows"></tbody>
      </table>
    </div>
  </div>

  <div class="section">Charts</div>
  <div class="chart">
    <div class="chart-title">NET WORTH (daily snapshots)</div>
    <div id="chartNetWorth">—</div>
  </div>

  <div class="chart" style="margin-top:12px;">
    <div class="chart-title">CASH (daily snapshots)</div>
    <div id="chartCash">—</div>
  </div>

  <div class="section">Notes</div>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="saveNote" disabled>SAVE NOTE</button>
    <span class="muted">Saved to Google Sheets.</span>
  </div>
  <textarea rows="6" id="notes" placeholder="Write note, then click SAVE NOTE…" disabled></textarea>

  <div class="section">Note History</div>
  <table>
    <thead>
      <tr>
        <th style="width:22%;">TIME</th>
        <th>NOTE</th>
      </tr>
    </thead>
    <tbody id="noteRows"></tbody>
  </table>
</div>

<script>
(() => {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHUYAzQBNE5qQXOs07z7Gg_d78qZOb4WNCirHBeJOSSRcOMMx-NxWqHTTzTZOvFmjo3w/exec";
  const TOKEN_KEY = "emanuel_burn_token_session";
  const $ = (id) => document.getElementById(id);

  const num = (x) => (isFinite(+x) ? +x : 0);
  const money = (n) => (isFinite(n) ? "$" + Number(n).toFixed(2) : "—");
  const pad2 = (x) => String(x).padStart(2,"0");
  const ymd = (d) => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  const fmt = (d) =>
    d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+
    " "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());

  function weekStartISO(d){
    const x = new Date(d);
    const day = (x.getDay()+6)%7; // Mon=0
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return ymd(x);
  }

  function showGate(){
    $("app").style.display = "none";
    $("gate").style.display = "";
  }

  function showApp(){
    $("gate").style.display = "none";
    $("app").style.display = "";
  }

  function setSync(text){ $("sync").textContent = text; }
  function showErr(on){ $("err").style.display = on ? "" : "none"; }
  function showGateErr(on){ $("gateErr").style.display = on ? "" : "none"; }
  function setGateMsg(msg){
    const el = $("gateMsg");
    if (!el) return;
    if (!msg) { el.style.display="none"; el.textContent=""; return; }
    el.style.display = "";
    el.textContent = msg;
  }
  function token(){ return sessionStorage.getItem(TOKEN_KEY) || ""; }

  async function apiGet(action){
    try {
      const url = `${SCRIPT_URL}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(token())}`;
      const res = await fetch(url, { cache:"no-cache" });
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { error:"bad_json", text }; }
    } catch (err) {
      return { error:"fetch_failed", text: String(err) };
    }
  }

  async function apiPost(action, payload){
    try {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action, token: token(), ...payload })
      });
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { error:"bad_json", text }; }
    } catch (err) {
      return { error:"fetch_failed", text: String(err) };
    }
  }

  function enableUI(on){
    ["includeSaul","avgIncome","inflow","cash","assetLiquid","assetOther","liabDebt",
     "snapDaily","snapWeekly","saveNote","notes","addRow","saveNow"].forEach(id=>{
      if ($(id)) $(id).disabled = !on;
    });
    document.querySelectorAll("#rows input, #rows select, #rows button").forEach(el=>{
      el.disabled = !on;
    });
  }

  const DEFAULT = {
    includeSaul: "yes",
    avgIncome: 3464.00,
    inflow: 3000.00,
    cash: 2578.89,

    assetLiquid: 5578.89,
    assetOther: 0.00,
    liabDebt: 0.00,

    rows: [
      {cat:"LIVING", item:"Housing - Rent", amount:800.00, due:"01", notes:"Due 1st", as:"you"},
      {cat:"LIVING", item:"Internet", amount:20.00, due:"", notes:"Monthly", as:"you"},
      {cat:"LIVING", item:"Food", amount:650.00, due:"", notes:"Monthly", as:"you"},
      {cat:"TRANSPORTATION", item:"Gas", amount:250.00, due:"", notes:"Monthly", as:"you"},
      {cat:"TRANSPORTATION", item:"Car Payment #1", amount:369.89, due:"11", notes:"Due 11th", as:"you"},
      {cat:"TRANSPORTATION", item:"Car Payment #2", amount:285.98, due:"17", notes:"Due 17th", as:"you"},
      {cat:"FAMILY AID", item:"Discover Card (Saul)", amount:50.00, due:"10", notes:"Due 10th", as:"saul"},
      {cat:"FAMILY AID", item:"Capital One (Saul)", amount:75.00, due:"22", notes:"Due 22nd", as:"saul"},
      {cat:"FAMILY AID", item:"Apple Card (Saul)", amount:257.16, due:"EOM", notes:"End of month", as:"saul"}
    ],
    updatedAt: ""
  };

  function parseState(sheetState){
    const out = {};
    out.includeSaul = String(sheetState.includeSaul || DEFAULT.includeSaul);
    out.avgIncome = num(sheetState.avgIncome ?? DEFAULT.avgIncome);
    out.inflow = num(sheetState.inflow ?? DEFAULT.inflow);
    out.cash = num(sheetState.cash ?? DEFAULT.cash);

    out.assetLiquid = num(sheetState.assetLiquid ?? DEFAULT.assetLiquid);
    out.assetOther  = num(sheetState.assetOther ?? DEFAULT.assetOther);
    out.liabDebt    = num(sheetState.liabDebt ?? DEFAULT.liabDebt);

    try { out.rows = JSON.parse(sheetState.rowsJson || "null") || DEFAULT.rows; }
    catch { out.rows = DEFAULT.rows; }

    out.updatedAt = String(sheetState.updatedAt || "");
    return out;
  }

  function buildSheetState(state){
    return {
      includeSaul: state.includeSaul,
      avgIncome: String(state.avgIncome),
      inflow: String(state.inflow),
      cash: String(state.cash),

      assetLiquid: String(state.assetLiquid),
      assetOther: String(state.assetOther),
      liabDebt: String(state.liabDebt),

      rowsJson: JSON.stringify(state.rows),
      updatedAt: new Date().toISOString()
    };
  }

  function esc(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function renderTable(state){
    const tbody = $("rows");
    tbody.innerHTML = "";

    state.rows.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="input small cat" data-idx="${idx}" value="${esc(r.cat||"")}"></td>
        <td><input class="input item" data-idx="${idx}" style="width:100%;" value="${esc(r.item||"")}"></td>
        <td class="num"><input class="input small amt" data-idx="${idx}" value="${num(r.amount).toFixed(2)}"></td>
        <td><input class="input tiny due" data-idx="${idx}" placeholder="DD / MM-DD / EOM" value="${esc(r.due||"")}"></td>
        <td><input class="input note" data-idx="${idx}" style="width:100%;" value="${esc(r.notes||"")}"></td>
        <td class="center">
          <select class="as" data-idx="${idx}">
            <option value="you">YOU</option>
            <option value="saul">SAUL</option>
            <option value="ignore">-</option>
          </select>
        </td>
        <td class="center"><button class="btn del" data-idx="${idx}">X</button></td>
      `;
      tbody.appendChild(tr);
      tr.querySelector("select.as").value = (r.as || "you");
    });
  }

  function endOfMonthDate(d){
    const x = new Date(d.getFullYear(), d.getMonth()+1, 0);
    x.setHours(0,0,0,0);
    return x;
  }

  function parseDueToDate(dueStr, now){
    const s = String(dueStr || "").trim();
    if (!s) return null;

    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const dt = new Date(s + "T00:00:00");
      return isNaN(dt.getTime()) ? null : dt;
    }
    if (s.toUpperCase() === "EOM") return endOfMonthDate(now);

    if (/^\d{2}-\d{2}$/.test(s)){
      const [mm, dd] = s.split("-").map(Number);
      if (!mm || !dd) return null;
      let dt = new Date(now.getFullYear(), mm-1, dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear()+1, mm-1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }

    if (/^\d{1,2}$/.test(s)){
      const dd = Number(s);
      if (!dd) return null;
      let dt = new Date(now.getFullYear(), now.getMonth(), dd);
      dt.setHours(0,0,0,0);
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt < today0){
        dt = new Date(now.getFullYear(), now.getMonth()+1, dd);
        dt.setHours(0,0,0,0);
      }
      return dt;
    }

    return null;
  }

  function renderDueList(state){
    const el = $("dueList");
    const now = new Date();
    const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const horizon = new Date(today0);
    horizon.setDate(horizon.getDate() + 14);

    const includeSaul = state.includeSaul !== "no";

    const upcoming = state.rows
      .map(r => ({ r, dueDate: parseDueToDate(r.due, now) }))
      .filter(x => x.r.as !== "ignore")
      .filter(x => includeSaul ? true : x.r.as !== "saul")
      .filter(x => x.dueDate && x.dueDate >= today0 && x.dueDate <= horizon)
      .sort((a,b)=>a.dueDate-b.dueDate);

    if (!upcoming.length){ el.textContent = "—"; return; }

    el.textContent = upcoming.map(x=>{
      const d = x.dueDate;
      const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      const who = x.r.as === "saul" ? "SAUL" : "YOU";
      return `${ds}  ${money(num(x.r.amount))}  ${who}  ${x.r.item}`;
    }).join("\n");
  }

  function secondsToDHMS(sec){
    if (!isFinite(sec) || sec < 0) return "—";
    sec = Math.floor(sec);
    const d = Math.floor(sec / 86400); sec %= 86400;
    const h = Math.floor(sec / 3600);  sec %= 3600;
    const m = Math.floor(sec / 60);    sec %= 60;
    return `${d}d ${pad2(h)}:${pad2(m)}:${pad2(sec)}`;
  }

  function calc(state){
    const includeSaul = state.includeSaul !== "no";
    let burnYou = 0, burnSaul = 0;

    state.rows.forEach(r=>{
      const a = num(r.amount);
      if (r.as === "you") burnYou += a;
      else if (r.as === "saul") burnSaul += a;
    });

    const burnTotal = burnYou + (includeSaul ? burnSaul : 0);
    const leftMo = state.avgIncome - burnTotal;

    const daily = burnTotal / 30.437;
    const weekly = daily * 7;
    const yearly = burnTotal * 12;

    const cashAfter = state.cash + state.inflow;
    const runway1 = daily > 0 ? (cashAfter / daily) : Infinity;

    const netWorth = (state.assetLiquid + state.assetOther) - state.liabDebt;

    const nw30  = netWorth + (leftMo/30.437)*30;
    const nw90  = netWorth + (leftMo/30.437)*90;
    const nw365 = netWorth + (leftMo/30.437)*365;

    const ratio = burnTotal > 0 ? (state.avgIncome / burnTotal) : Infinity;

    return { burnTotal, leftMo, daily, weekly, yearly, runway1, ratio, netWorth, nw30, nw90, nw365 };
  }

  function renderCalc(state){
    const c = calc(state);

    $("burnTotal").textContent = money(c.burnTotal);
    $("leftMo").textContent    = money(c.leftMo);
    $("daily").textContent     = money(c.daily);
    $("weekly").textContent    = money(c.weekly);
    $("yearly").textContent    = money(c.yearly);
    $("runway1").textContent   = isFinite(c.runway1) ? c.runway1.toFixed(0) : "∞";
    $("ratio").textContent     = isFinite(c.ratio) ? c.ratio.toFixed(2) : "∞";

    $("netWorth").textContent  = money(c.netWorth);
    $("nw30").textContent      = money(c.nw30);
    $("nw90").textContent      = money(c.nw90);
    $("nw365").textContent     = money(c.nw365);

    window.__burnCountdownSeconds = isFinite(c.runway1) ? Math.floor(c.runway1 * 86400) : Infinity;
    $("burnCountdown").textContent = secondsToDHMS(window.__burnCountdownSeconds);

    renderDueList(state);
    return c;
  }

  // charts/snapshots/notes + saving left unchanged from your version
  // (kept minimal: your page "not working" is auth/network; this block is enough to show the real error)

  async function loadAll(){
    setSync("CONNECTING…");
    showErr(false);
    showGateErr(false);
    setGateMsg("");

    const data = await apiGet("getAll");

    if (data && data.error){
      enableUI(false);
      showGate();
      showGateErr(true);
      setGateMsg(`LOGIN FAILED: ${data.error}`);
      console.log("loadAll error:", data);
      return false;
    }

    // If your Apps Script returns ok JSON, show app
    showApp();
    enableUI(true);
    setSync("CONNECTED");

    // If you want the full app to populate, keep the rest of your original loadAll body here.
    // For now: at least you won't be blank; you'll see the failure reason if it fails.
    return true;
  }

  // gate login
  $("loginBtnGate").addEventListener("click", async ()=>{
    const pass = prompt("PASSCODE:");
    if (!pass) return;
    sessionStorage.setItem(TOKEN_KEY, pass);
    await loadAll();
  });

  // boot: blank until login
  showGate();
  enableUI(false);

  // if token exists, try auto-load
  if (token()){
    loadAll();
  }
})();
</script>
</body>
</html>
