// ====== CONFIG ======
const SPREADSHEET_ID = "PASTE_SHEET_ID_ONLY_HERE"; // example: 1JbNcBmNs6VdauH1V--Ha4_2D2_rTpb1yW-Ld1kf6blk

// Script Properties:
// TOKEN = your passcode (example: Epayn2030)
// OPTIONAL: RATE_LIMIT_PER_MIN = "60"

function doGet(e) {
  const token = (e.parameter.token || "");
  if (!isAuthed(token)) return json({ error: "unauthorized" });
  if (!rateLimitOk(token)) return json({ error: "rate_limited" });

  const action = e.parameter.action || "";
  if (action === "getAll") return json(getAll_());
  return json({ error: "unknown_action" });
}

function doPost(e) {
  let body = {};
  try {
    body = JSON.parse((e.postData && e.postData.contents) || "{}");
  } catch (err) {
    return json({ error: "bad_json" });
  }

  const token = (body.token || "");
  if (!isAuthed(token)) return json({ error: "unauthorized" });
  if (!rateLimitOk(token)) return json({ error: "rate_limited" });

  const action = body.action || "";
  if (action === "saveState") return json(saveState_(body.state || {}));
  if (action === "addSnapshot") return json(addSnapshot_(body.snapshot || {}));
  if (action === "addNote") return json(addNote_(body.note || ""));
  if (action === "clearAll") return json(clearAll_());
  return json({ error: "unknown_action" });
}

// ====== AUTH + RATE LIMIT ======
function isAuthed(token) {
  const expected = PropertiesService.getScriptProperties().getProperty("TOKEN");
  return expected && token && token === expected;
}

function rateLimitOk(token){
  const props = PropertiesService.getScriptProperties();
  const limit = Number(props.getProperty("RATE_LIMIT_PER_MIN") || "60");

  const cache = CacheService.getScriptCache();
  const key = "rl:" + token;
  const raw = cache.get(key);
  const n = raw ? Number(raw) : 0;

  if (n >= limit) return false;

  // increment and keep for 60s
  cache.put(key, String(n + 1), 60);
  return true;
}

// ====== SHEETS HELPERS ======
function ss_(){ return SpreadsheetApp.openById(SPREADSHEET_ID); }

function ensureSheet_(name, headers){
  const s = ss_();
  let sh = s.getSheetByName(name);
  if (!sh) sh = s.insertSheet(name);

  const lastRow = sh.getLastRow();
  if (lastRow < 1){
    sh.getRange(1,1,1,headers.length).setValues([headers]);
  } else {
    const existing = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0].map(String);
    const ok = headers.every((h,i)=>existing[i]===h);
    if (!ok){
      sh.clearContents();
      sh.getRange(1,1,1,headers.length).setValues([headers]);
    }
  }
  return sh;
}

function readRows_(sh){
  const values = sh.getDataRange().getValues();
  if (values.length < 2) return [];
  const headers = values[0].map(String);
  const out = [];
  for (let i=1;i<values.length;i++){
    const r = {};
    for (let j=0;j<headers.length;j++){
      r[headers[j]] = values[i][j];
    }
    out.push(r);
  }
  return out;
}

function readState_(sh){
  const values = sh.getDataRange().getValues();
  if (values.length < 2) return {};
  const out = {};
  for (let i=1;i<values.length;i++){
    const k = values[i][0];
    const v = values[i][1];
    if (k) out[String(k)] = v;
  }
  return out;
}

// ====== ACTIONS ======
function getAll_(){
  const s = ss_();
  const stateSh = ensureSheet_("state", ["key","value"]);
  const snapsSh = ensureSheet_("snapshots", ["type","ts","ymd","week","burn","income","cash","net","runway","includeSaul"]);
  const notesSh = ensureSheet_("notes", ["ts","note"]);

  return {
    state: readState_(stateSh),
    snapshots: readRows_(snapsSh),
    notes: readRows_(notesSh)
  };
}

function saveState_(obj){
  const stateSh = ensureSheet_("state", ["key","value"]);
  stateSh.clearContents();
  stateSh.getRange(1,1,1,2).setValues([["key","value"]]);

  const keys = Object.keys(obj || {});
  if (!keys.length) return { ok:true };

  const rows = keys.map(k => [String(k), String(obj[k])]);
  stateSh.getRange(2,1,rows.length,2).setValues(rows);

  return { ok:true };
}

function addSnapshot_(snap){
  const snapsSh = ensureSheet_("snapshots", ["type","ts","ymd","week","burn","income","cash","net","runway","includeSaul"]);
  const ts = new Date().toISOString();

  snapsSh.appendRow([
    snap.type || "daily",
    ts,
    snap.ymd || "",
    snap.week || "",
    snap.burn || "",
    snap.income || "",
    snap.cash || "",
    snap.net || "",
    snap.runway || "",
    snap.includeSaul || ""
  ]);

  return { ok:true, ts };
}

function addNote_(note){
  const notesSh = ensureSheet_("notes", ["ts","note"]);
  const ts = new Date().toISOString();
  notesSh.appendRow([ts, String(note || "")]);
  return { ok:true, ts };
}

function clearAll_(){
  const s = ss_();
  ["state","snapshots","notes"].forEach(name=>{
    const sh = s.getSheetByName(name);
    if (sh) sh.clearContents();
  });
  ensureSheet_("state", ["key","value"]);
  ensureSheet_("snapshots", ["type","ts","ymd","week","burn","income","cash","net","runway","includeSaul"]);
  ensureSheet_("notes", ["ts","note"]);
  return { ok:true };
}

function json(obj){
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
